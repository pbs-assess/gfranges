---
title: "Plot responses to model covariates to inform threshold choices for VOCC"
author: "Philina English"
date: '2019-07-18'
output: html_document
---

Species
```{r}
# species <- params$species
# # Species run so far...
# species <- "Arrowtooth Flounder" # still throws error for some models
# species <- "Pacific Cod"
# species <- "Sablefish"
# species <- "Silvergray Rockfish" # this one looks good!
# species <- "Lingcod"
# species <- "North Pacific Spiny Dogfish" # note: using all data for maturity thresholds
 species <- "Quillback Rockfish"
# species <- "Pacific Ocean Perch"
# species <- "Yelloweye Rockfish"
```

Choose model details
```{r}
covariates <- ""
# covariates <- "+muddy+mixed+rocky"
# covariates <- "+mixed+rocky"
#covariates <- "+muddy+any_rock"
# covariates <- "+trawled+muddy+rocky+mixed"
# covariates <- "+trawled+mixed+rocky"
# covariates <- "+trawled+mixed"

# priors <- FALSE
# covariates <- "+muddy+any_rock"
# covs <- gsub("\\+", "-", covariates)
priors <- TRUE
covs <- "-tv-depth"
#covs <- "-both-tv-depth"
```

Run all subsequent code...
```{r global_options, include=FALSE}
spp <- gsub(" ", "-", gsub("\\/", "-", tolower(species)))

# folder to hold figs for this species
dir.create(file.path("figs", spp))
dir.create(file.path("data", spp))

knitr::opts_chunk$set(
  fig.width = 11, fig.height = 8.5,
  fig.path = paste0("figs/", spp, "/"),
  echo = FALSE, warning = FALSE, message = FALSE
)
```

```{r, message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
library(gfplot)
library(gfdata)
library(sdmTMB)
library(gfranges)
```

Load Dissolved O2 models
```{r}
rm(adult, imm,
  adult_survey1, imm_survey1,
  adult_survey4, imm_survey4,
  adult_survey16, imm_survey16)

try({
  survey <- c("SYN QCS", "SYN HS", "SYN WCVI", "SYN WCHG")
  model_ssid <- c(1, 3, 4, 16)
  ssid_string <- paste0(model_ssid, collapse = "n")
  adult <- readRDS(paste0("data/", spp,
    "/mod-mat-biomass-", spp, "-fixed-do", covs, "-", ssid_string, "-prior-", priors, ".rds"
  ))
  imm <- readRDS(paste0("data/", spp,
    "/mod-imm-biomass-", spp, "-fixed-do", covs, "-", ssid_string, "-prior-", priors, ".rds"
  ))
})
if (!exists("adult")) adult <- NULL
if (!exists("imm")) imm <- NULL

try({
  survey <- c("SYN QCS", "SYN HS")
  model_ssid <- c(1, 3)
  ssid_string <- paste0(model_ssid, collapse = "n")
  adult_survey1 <- readRDS(paste0("data/", spp,
    "/mod-mat-biomass-", spp, "-fixed-do", covs, "-", ssid_string, "-prior-", priors, ".rds"
  ))
  imm_survey1 <- readRDS(paste0("data/", spp,
    "/mod-imm-biomass-", spp, "-fixed-do", covs, "-", ssid_string, "-prior-", priors, ".rds"
  ))
})
if (!exists("adult_survey1")) adult_survey1 <- NULL
if (!exists("imm_survey1")) imm_survey1 <- NULL

try({
  survey <- c("SYN WCVI")
  model_ssid <- c(4)
  ssid_string <- paste0(model_ssid, collapse = "n")
  adult_survey4 <- readRDS(paste0("data/", spp,
    "/mod-mat-biomass-", spp, "-fixed-do", covs, "-", ssid_string, "-prior-", priors, ".rds"
  ))
  imm_survey4 <- readRDS(paste0("data/", spp,
    "/mod-imm-biomass-", spp, "-fixed-do", covs, "-", ssid_string, "-prior-", priors, ".rds"
  ))
})
if (!exists("adult_survey4")) adult_survey4 <- NULL
if (!exists("imm_survey4")) imm_survey4 <- NULL

try({
  survey <- c("SYN WCHG")
  model_ssid <- c(16)
  ssid_string <- paste0(model_ssid, collapse = "n")
  adult_survey16 <- readRDS(paste0("data/", spp,
    "/mod-mat-biomass-", spp, "-fixed-do", covs, "-", ssid_string, "-prior-", priors, ".rds"
  ))
  imm_survey16 <- readRDS(paste0("data/", spp,
    "/mod-imm-biomass-", spp, "-fixed-do", covs, "-", ssid_string, "-prior-", priors, ".rds"
  ))
})
if (!exists("adult_survey16")) adult_survey16 <- NULL
if (!exists("imm_survey16")) imm_survey16 <- NULL

model_list <- list(
  adult = adult, imm = imm,
  adult_survey1 = adult_survey1, imm_survey1 = imm_survey1,
  adult_survey4 = adult_survey4, imm_survey4 = imm_survey4,
  adult_survey16 = adult_survey16#, imm_survey16 = imm_survey16
)
model_list <- model_list[!sapply(model_list, is.null)]
```

```{r}
# test load small sdm model to avoid crashing R
# try({imm})
# or maybe it's crashing when NaNs produced error goes into density function?
```

Load temperature models
```{r}
rm(adult, imm,
  adult_survey1, imm_survey1,
  adult_survey4, imm_survey4,
  adult_survey16, imm_survey16)

try({
  survey <- c("SYN QCS", "SYN HS", "SYN WCVI", "SYN WCHG")
  model_ssid <- c(1, 3, 4, 16)
  ssid_string <- paste0(model_ssid, collapse = "n")
  adult <- readRDS(paste0("data/", spp,
    "/mod-mat-biomass-", spp, "-fixed-temp", covs, "-", ssid_string, "-prior-", priors, ".rds"
  ))
  imm <- readRDS(paste0("data/", spp,
    "/mod-imm-biomass-", spp, "-fixed-temp", covs, "-", ssid_string, "-prior-", priors, ".rds"
  ))
})
if (!exists("adult")) adult <- NULL
if (!exists("imm")) imm <- NULL

try({
  survey <- c("SYN QCS", "SYN HS")
  model_ssid <- c(1, 3)
  ssid_string <- paste0(model_ssid, collapse = "n")
  adult_survey1 <- readRDS(paste0("data/", spp,
    "/mod-mat-biomass-", spp, "-fixed-temp", covs, "-", ssid_string, "-prior-", priors, ".rds"
  ))
  imm_survey1 <- readRDS(paste0("data/", spp,
    "/mod-imm-biomass-", spp, "-fixed-temp", covs, "-", ssid_string, "-prior-", priors, ".rds"
  ))
})
if (!exists("adult_survey1")) adult_survey1 <- NULL
if (!exists("imm_survey1")) imm_survey1 <- NULL

try({
  survey <- c("SYN WCVI")
  model_ssid <- c(4)
  ssid_string <- paste0(model_ssid, collapse = "n")
  adult_survey4 <- readRDS(paste0("data/", spp,
    "/mod-mat-biomass-", spp, "-fixed-temp", covs, "-", ssid_string, "-prior-", priors, ".rds"
  ))
  imm_survey4 <- readRDS(paste0("data/", spp,
    "/mod-imm-biomass-", spp, "-fixed-temp", covs, "-", ssid_string, "-prior-", priors, ".rds"
  ))
})
if (!exists("adult_survey4")) adult_survey4 <- NULL
if (!exists("imm_survey4")) imm_survey4 <- NULL

try({
  survey <- c("SYN WCHG")
  model_ssid <- c(16)
  ssid_string <- paste0(model_ssid, collapse = "n")
  adult_survey16 <- readRDS(paste0(
    "data/", spp,
    "/mod-mat-biomass-", spp, "-fixed-temp", covs, "-", ssid_string, "-prior-", priors, ".rds"
  ))
  imm_survey16 <- readRDS(paste0(
    "data/", spp,
    "/mod-imm-biomass-", spp, "-fixed-temp", covs, "-", ssid_string, "-prior-", priors, ".rds"
  ))
})
if (!exists("adult_survey16")) adult_survey16 <- NULL
if (!exists("imm_survey16")) imm_survey16 <- NULL

temp_model_list <- list(
  adult = adult, imm = imm, 
  adult_survey1 = adult_survey1, imm_survey1 = imm_survey1,
  adult_survey4 = adult_survey4, imm_survey4 = imm_survey4,
  adult_survey16 = adult_survey16, imm_survey16 = imm_survey16
)
temp_model_list <- temp_model_list[!sapply(temp_model_list, is.null)]
```

## Density curves from model coefficients

#### Calculate DO curves
```{r}
do <- list()
do_plots <- list()

for (i in seq_len(length(model_list))) {
 do[[i]] <- fixed_density(model_list[[i]], predictor = "do_mlpl")
 if (length(do[[i]])>0) {
   do[[i]]$species <- species
   do[[i]]$model <- names(model_list[i])
   do[[i]]$covs <- covs 
   do[[i]]$optimal_do <- get_optimal_value(do[[i]], xlimits = c(0.5, 6))
   do_plots[[i]] <- 
     plot_mountains(do[[i]], variable_label = "Dissolved O2", xlimits = c(0, 8)) +
        ggtitle(paste(species, names(model_list[i])))
   } else {
    do_plots[[i]] <- grid::grid.rect(gp = grid::gpar(col = "white"))
  }
}

odat <- do.call("rbind", do) 
if (length(odat)>0) {
  odat <- odat %>% group_by(model) %>%
  mutate(age = ifelse(grepl("imm", model), "imm", "adult"),
    do_maxy = max(y_hat)) %>% 
  select(species, age, model, optimal_do, do_maxy, covs) %>% 
  distinct() 
} else {
  odat <- NULL
}
print(do_plots)
```

#### Calculate temperature curves
```{r}
td <- list()
temp_plots <- list()
for (i in seq_len(length(temp_model_list))) {
  td[[i]] <- fixed_density(temp_model_list[[i]], predictor = "temp")
  if (length(td[[i]])>0) {
    td[[i]]$species <- species
    td[[i]]$model <- names(temp_model_list[i])
    td[[i]]$covs <- covs
    td[[i]]$optimal_temp <- get_optimal_value(td[[i]], xlimits = c(0, 12))
    temp_plots[[i]] <- plot_mountains(td[[i]], variable_label = "Temperature", xlimits = c(2, 10)) + 
      ggtitle(paste(species, names(temp_model_list[i])))
  } else {
    temp_plots[[i]] <- grid::grid.rect(gp = grid::gpar(col = "white"))
  }
}

tdat <- do.call("rbind", td) 
if (length(tdat)>0) {
  tdat <- tdat %>% group_by(model) %>%
  mutate(age = ifelse(grepl("imm", model), "imm", "adult"),
    t_maxy = max(y_hat)) %>% 
  select(species, age, model, optimal_temp, t_maxy, covs) %>%
  distinct() 
} else {
  tdat <- NULL
}
print(temp_plots)
```



## Check optimals against raw capture denstiies

#### Combine biomass and sensor data
```{r}
  model_ssid <- c(1, 3, 4, 16)
  ssid_string <- paste0(model_ssid, collapse = "n")
  biomass <- readRDS(paste0(
    "data/", spp, "/data-by-maturity-", spp, "-", ssid_string, ".rds"
    ))
  covars <- readRDS("data/event-covariates.rds")
  data <- dplyr::left_join(biomass, covars) %>% mutate(depth_akima = depth) %>% select(-depth)
  
  CTD <- readRDS("../tmb-sensor-explore/data/all-sensor-data-processed.rds")
  data <- dplyr::left_join(data, CTD) %>% 
    mutate(exclude = if_else(do_mlpl>8, 1, 0)) %>% 
    #mutate(exclude = if_else(do_mlpl>6, 1, 0)) %>% #try excluding high values?
    filter(exclude != 1) %>% # added on july 24 after first round of models run...
    filter(year > 2007) # 2007 DO data is flawed
  
  # scale predictors before filtering to ensure mean and SD are global
  data <- data %>% mutate(raw_depth = depth_bath, depth = log(raw_depth), temp = temperature_c) 
```

#### Plot raw DO
```{r}
odata <- data %>% filter(!is.na(do_mlpl)) %>% 
  mutate(ad_density_class = ifelse(adult_density==0, 0, (round(log10((adult_density*10000)+1)*2)+1)),
    im_density_class = ifelse(imm_density==0, 0, (round(log10((imm_density*10000)+1)*2)+1))) %>% 
  group_by(ad_density_class) %>% mutate(ad_mean_density = mean(adult_density, na.rm = TRUE)) %>% ungroup() %>%
  group_by(im_density_class) %>% mutate(im_mean_density = mean(imm_density, na.rm = TRUE)) %>% ungroup()
  
ad_density_class_labs <- unique(signif(odata$ad_mean_density*10000),2) # convert to kg/ha
ad_density_class_labs <- ad_density_class_labs[order(ad_density_class_labs)]
ad_density_class_labs <- formatC(ad_density_class_labs, digits = 1, format = "fg")
ad_density_class_labs

im_density_class_labs <- unique(signif(odata$im_mean_density*10000),2) # convert to kg/ha
im_density_class_labs <- im_density_class_labs[order(im_density_class_labs)]
im_density_class_labs <- formatC(im_density_class_labs, digits = 1, format = "fg")
im_density_class_labs

do_count_ad <- ggplot(odata, aes(x = do_mlpl, stat(count), fill = as.factor(ad_density_class))) +
  geom_density(position = "stack") +
  scale_fill_viridis_d(name = "Mean Density \n(kg/ha)", label=ad_density_class_labs) + 
  geom_vline(xintercept=odat[odat$model =="adult", ]$optimal_do, color="black",  size=1, na.rm = TRUE) +
  geom_vline(xintercept=odat[odat$age =="adult", ]$optimal_do, color="black", linetype="dashed", size=0.5, na.rm = TRUE) +
  theme_pbs() +
  xlab("Dissolved O2 from CTD (ml/L)") +
  ylab("Count") +
  ggtitle(paste("Adult"))

do_prop_ad <- ggplot(odata, aes(x = do_mlpl, stat(count), fill = as.factor(ad_density_class))) +
  geom_density(position = "fill") +
  scale_fill_viridis_d(name = "Mean Density \n(kg/ha)", label=ad_density_class_labs) + 
  geom_vline(xintercept=odat[odat$model =="adult", ]$optimal_do, color="black",  size=1, na.rm = TRUE) +
  geom_vline(xintercept=odat[odat$age =="adult", ]$optimal_do, color="black", linetype="dashed", size=0.5, na.rm = TRUE) +
  theme_pbs() +
  xlab("Dissolved O2 from CTD (ml/L)") +
  ylab("Proportion") +
  ggtitle(paste("Adult"))

do_count_im <- ggplot(odata, aes(x = do_mlpl, stat(count), fill = as.factor(im_density_class))) +
  geom_density(position = "stack") +
  scale_fill_viridis_d(name = "Mean Density \n(kg/ha)", label=im_density_class_labs) + 
  geom_vline( xintercept = odat[odat$model =="imm", ]$optimal_do, color="black",  size=1, na.rm = TRUE) +
  geom_vline( xintercept = odat[odat$age =="imm", ]$optimal_do, color="black", linetype="dashed", size=0.5, na.rm = TRUE) +
  theme_pbs() +
  xlab("Dissolved O2 from CTD (ml/L)") +
  ylab("Count") +
  ggtitle(paste("Immature"))

do_prop_im <- ggplot(odata, aes(x = do_mlpl, stat(count), fill = as.factor(im_density_class))) +
  geom_density(position = "fill") +
  scale_fill_viridis_d(name = "Mean Density \n(kg/ha)", label=im_density_class_labs) + 
  geom_vline( xintercept = odat[odat$model =="imm", ]$optimal_do, color="black",  size=1, na.rm = TRUE) +
  geom_vline( xintercept = odat[odat$age =="imm", ]$optimal_do, color="black", linetype="dashed", size=0.5, na.rm = TRUE) +
  theme_pbs() +
  xlab("Dissolved O2 from CTD (ml/L)") +
  ylab("Proportion") +
  ggtitle(paste("Immature"))

do_count_ad
do_prop_ad
do_count_im
do_prop_im
```

#### Plot raw temperature
```{r}
tdata <- data %>% filter(!is.na(temp)) %>% 
  mutate(ad_density_class = ifelse(adult_density==0, 0, (round(log10((adult_density*10000)+1)*2)+1)),
    im_density_class = ifelse(imm_density==0, 0, (round(log10((imm_density*10000)+1))+1)*2)) %>% 
  group_by(ad_density_class) %>% mutate(ad_mean_density = mean(adult_density, na.rm = TRUE)) %>% ungroup() %>%
  group_by(im_density_class) %>% mutate(im_mean_density = mean(imm_density, na.rm = TRUE)) %>% ungroup()
  
ad_density_class_labs <- unique(signif(tdata$ad_mean_density*10000),2) # convert to kg/ha
ad_density_class_labs <- ad_density_class_labs[order(ad_density_class_labs)]
ad_density_class_labs <- formatC(ad_density_class_labs, digits = 1, format = "fg")
ad_density_class_labs

im_density_class_labs <- unique(signif(tdata$im_mean_density*10000),2) # convert to kg/ha
im_density_class_labs <- im_density_class_labs[order(im_density_class_labs)]
im_density_class_labs <- formatC(im_density_class_labs, digits = 1, format = "fg")
im_density_class_labs

#FIXME: breaks when no optimals are available
t_count_ad <- ggplot(tdata, aes(x = temp, stat(count),fill = as.factor(ad_density_class))) + 
  geom_density(position = "stack") +
  scale_fill_viridis_d(name = "Mean Density \n(kg/ha)", label=ad_density_class_labs) + 
  geom_vline(xintercept=tdat[tdat$model =="adult", ]$optimal_temp, color="black",  size=1, na.rm = TRUE) +
  geom_vline(xintercept=tdat[tdat$age =="adult", ]$optimal_temp, color="black", linetype="dashed", size=0.5, na.rm = TRUE) +
  theme_pbs() +
  xlab("Temperature from CTD") +
  ylab("Count") +
  ggtitle(paste("Adult"))

t_prop_ad <- ggplot(tdata, aes(x = temp, stat(count), fill = as.factor(ad_density_class))) +
  geom_density(position = "fill") +
  scale_fill_viridis_d(name = "Mean Density \n(kg/ha)", label=ad_density_class_labs) + 
  geom_vline(xintercept=tdat[tdat$model =="adult", ]$optimal_temp, color="black", size=1, na.rm = TRUE) +
  geom_vline(xintercept=tdat[tdat$age =="adult", ]$optimal_temp, color="black", linetype="dashed", size=0.5, na.rm = TRUE) +
  theme_pbs() +
  xlab("Temperature from CTD") +
  ylab("Proportion") +
  ggtitle(paste("Adult"))

t_count_im <- ggplot(tdata, aes(x = temp, stat(count), fill = as.factor(im_density_class))) + 
  geom_density(position = "stack") +
  scale_fill_viridis_d(name = "Mean Density \n(kg/ha)", label=im_density_class_labs) + 
  geom_vline( xintercept = tdat[tdat$model =="imm", ]$optimal_temp, color="black", size=1, na.rm = TRUE) +
  geom_vline( xintercept = tdat[tdat$age =="imm", ]$optimal_temp, color="black", linetype="dashed", size=0.5, na.rm = TRUE) +
  theme_pbs() +
  xlab("Temperature from CTD") +
  ylab("Count") +
  ggtitle(paste("Immature"))

t_prop_im <- ggplot(tdata, aes(x = temp, stat(count), fill = as.factor(im_density_class))) +
  geom_density(position = "fill") +
  scale_fill_viridis_d(name = "Mean Density \n(kg/ha)", label=im_density_class_labs) + 
  geom_vline( xintercept = tdat[tdat$model =="imm", ]$optimal_temp, color="black", size=1, na.rm = TRUE) +
  geom_vline( xintercept = tdat[tdat$age =="imm", ]$optimal_temp, color="black", linetype="dashed", size=0.5, na.rm = TRUE) +
  theme_pbs() +
  xlab("Temperature from CTD") +
  ylab("Proportion") +
  ggtitle(paste("Immature"))

t_count_ad
t_prop_ad 
t_count_im 
t_prop_im 
```


Save DO plots
```{r}
png(
  file = paste0("figs/", spp, "/do-fixed-", spp, covs, "-priors-", priors, ".png"),
  res = 600,
  units = "in",
  width = 8.5,
  height = 11
)
gridExtra::grid.arrange(
  grobs = do_plots,
  ncol = 2,
  top = grid::textGrob(paste(species))
)
dev.off()
```

Save Temperature plots
```{r}
png(
  file = paste0("figs/", spp, "/temp-fixed-", spp, covs, "-priors-", priors, ".png"),
  res = 600,
  units = "in",
  width = 8.5,
  height = 11
)
gridExtra::grid.arrange(
  grobs = temp_plots,
  ncol = 2,
  top = grid::textGrob(paste(species))
)
dev.off()
```

#### Save plots of raw densities vs model optimals 
```{r}
png(
  file = paste0("figs/", spp, "/check-optimals-", spp, covs, "-priors-", priors, ".png"),
  res = 600,
  units = "in",
  width = 8.5,
  height = 11
)
gridExtra::grid.arrange( do_count_ad, do_count_im, do_prop_ad, do_prop_im, t_count_ad, t_count_im, t_prop_ad, t_prop_im, 
  ncol = 2,
  top = grid::textGrob(paste("Raw densities of", species, "with modeled optimals in vertical lines (if solid includes all surveys)"))
)
dev.off()
```

## Save optimal values
```{r eval=FALSE}
other_params <- readRDS(paste0("data/optimal-values-by-species-by-age-tv-depth.rds"))

if(!is.null(odat)) {
  if(!is.null(tdat)) {
    params <- full_join(tdat, odat, by=c("species", "age", "model", "covs"))
    all_params <- full_join(other_params, params)
  } else {
  try({all_params <- full_join(other_params, odat)})
  }
} else {
  try({all_params <- full_join(other_params, tdat)})
}

all_params <- all_params %>% distinct()
saveRDS(all_params, file = "data/optimal-values-by-species-by-age-tv-depth.rds")
all_params
```










Alternative presense-absense code
```{r eval=FALSE}
odata <- data %>% filter(!is.na(do_mlpl)) #%>% filter(do_mlpl < 1.5)

odata1 <- filter(odata, adult_density > 0)
# ymax <- which.max(density(odata1$do_mlpl)$y)
# do_optimal_raw <- density(odata1$do_mlpl)$x[ymax]

oplot <- ggplot(odata1) + 
  geom_density(aes(x = do_mlpl), colour = "blue") +
  # geom_vline(aes(xintercept=do_optimal_raw),
  #           color="blue", linetype="dashed", size=1) +
  geom_density(data=filter(odata, adult_density == 0), aes(x = do_mlpl), colour = "red", inherit.aes = FALSE) + theme_bw() +
  xlab("Dissolved O2 from CTD (ml/L)") +
  ylab("Frequency") +
  ggtitle(paste("Adult"))
oplot

oploti <- ggplot(filter(odata, imm_density > 0)) + geom_density(aes(x = do_mlpl), colour = "blue") + 
  geom_density(data=filter(odata, imm_density == 0), aes(x = do_mlpl), colour = "red", inherit.aes = FALSE) + theme_bw() +
  xlab("Dissolved O2 from CTD (ml/L)") +
  ylab("Frequency") +
  ggtitle(paste("Immature"))
oploti


tdata <- data %>% filter(!is.na(temp)) #%>% filter(do_mlpl < 1.5)
tplot <-ggplot(filter(tdata, adult_density > 0)) + geom_density(aes(x = temp), colour = "blue") + 
  geom_density(data=filter(tdata, adult_density == 0), aes(x = temp), colour = "red", inherit.aes = FALSE) + theme_bw() +
  xlab("Temperature from CTD") +
  ylab("Frequency") +
  ggtitle(paste("Adult"))
tplot
tploti <-ggplot(filter(tdata, imm_density > 0)) + geom_density(aes(x = temp), colour = "blue") + 
  geom_density(data=filter(tdata, imm_density == 0), aes(x = temp), colour = "red", inherit.aes = FALSE) + theme_bw() +
  xlab("Temperature from CTD") +
  ylab("Frequency") +
  ggtitle(paste("Immature"))
tploti
```

Save raw presense-absence density plots
```{r eval=FALSE}
png(
  file = paste0("figs/", spp, "/raw-presense-by-climate-", spp, "-density-plots.png"),
  res = 600,
  units = "in",
  width = 8.5,
  height = 11
)
gridExtra::grid.arrange(
  oplot,  tplot, oploti, tploti,
  ncol = 2,
  top = grid::textGrob(paste("Proportion of tows with", species, "(blue) vs without (red)"), gp=grid::gpar(fontsize=16))
)
dev.off()
```


Load Depth models
```{r}
rm(
  adult_survey1, imm_survey1,
  adult_survey4, imm_survey4,
  adult_survey16, imm_survey16
)
priors <- FALSE
covariates <- "+muddy+any_rock"
covs <- gsub("\\+", "-", covariates)
try({
  survey <- c("SYN QCS", "SYN HS")
  model_ssid <- c(1, 3)
  ssid_string <- paste0(model_ssid, collapse = "n")
  adult_survey1 <- readRDS(paste0("data/", spp,
    "/mod-mat-biomass-", spp, covs, "-", ssid_string, "-prior-", priors, ".rds"
  ))
  imm_survey1 <- readRDS(paste0("data/", spp,
    "/mod-imm-biomass-", spp, covs, "-", ssid_string, "-prior-", priors, ".rds"
  ))
})
if (!exists("adult_survey1")) adult_survey1 <- NULL
if (!exists("imm_survey1")) imm_survey1 <- NULL

try({
  survey <- c("SYN WCVI")
  model_ssid <- c(4)
  ssid_string <- paste0(model_ssid, collapse = "n")
  adult_survey4 <- readRDS(paste0("data/", spp,
    "/mod-mat-biomass-", spp, covs, "-", ssid_string, "-prior-", priors, ".rds"
  ))
  imm_survey4 <- readRDS(paste0("data/", spp,
    "/mod-imm-biomass-", spp, covs, "-", ssid_string, "-prior-", priors, ".rds"
  ))
})
if (!exists("adult_survey4")) adult_survey4 <- NULL
if (!exists("imm_survey4")) imm_survey4 <- NULL

try({
  survey <- c("SYN WCHG")
  model_ssid <- c(16)
  ssid_string <- paste0(model_ssid, collapse = "n")
  adult_survey16 <- readRDS(paste0("data/", spp,
    "/mod-mat-biomass-", spp, covs, "-", ssid_string, "-prior-", priors, ".rds"
  ))
  imm_survey16 <- readRDS(paste0("data/", spp,
    "/mod-imm-biomass-", spp, covs, "-", ssid_string, "-prior-", priors, ".rds"
  ))
})

if (!exists("adult_survey16")) adult_survey16 <- NULL
if (!exists("imm_survey16")) imm_survey16 <- NULL

depth_model_list <- list(
  adult_survey1 = adult_survey1, imm_survey1 = imm_survey1,
  adult_survey4 = adult_survey4, imm_survey4 = imm_survey4,
  adult_survey16 = adult_survey16, imm_survey16 = imm_survey16
)
depth_model_list <- depth_model_list[!sapply(depth_model_list, is.null)]
```

Build depth plots
```{r}
d <- list()
depth_plots <- list()
for (i in seq_len(length(depth_model_list))) {
  d[[i]] <- time_varying_density(depth_model_list[[i]], predictor = "depth")

  if (length(d[[i]]) == 0) {
    depth_plots[[i]] <- grid::grid.rect(gp = grid::gpar(col = "white"))
  } else {
    d[[i]]$x <- exp(d[[i]]$x)
    depth_plots[[i]] <- plot_mountains(d[[i]], variable_label = "Depth", xlimits = c(0, 800)) +
      ggtitle(paste(species, names(depth_model_list[i])))
  }
}
print(depth_plots)
```

```{r}
png(
  file = paste0(
    "figs/", spp,
    "/depth-", spp, covs, "-priors-", priors, ".png"
  ),
  res = 600,
  units = "in",
  width = 8.5,
  height = 11
)
gridExtra::grid.arrange(
  grobs = depth_plots,
  ncol = 2,
  top = grid::textGrob(paste(species))
)
dev.off()
```


Plot time-varying effect of trawling at mean depth
```{r}
trawl_plots <- list()
for (i in seq_len(length(depth_model_list))) {
  r <- depth_model_list[[i]]$tmb_obj$report()
  b3 <- r$b_rw_t[, 3]
  yrs <- sort(unique(depth_model_list[[i]]$data$year))
  b_j <- depth_model_list[[i]]$model$par[1:length(yrs)]

  SE <- 0.35 # Place-holder

  trawled <- data.frame(year = yrs, intercept = b_j, trawling = b3)

  # trawl_plots[[i]] <- ggplot(trawled, aes(year, y=exp(trawling) ) ) +
  #   geom_point(colour ="red") +
  #   #geom_pointrange(aes(ymin=exp(intercept-0.35), ymax=exp(intercept+0.35))) +
  #   ylab("Difference in kg/ha within trawled zone") + ggtitle(names(depth_model_list[i]))

  trawl_plots[[i]] <- ggplot(trawled, aes(year, exp(intercept))) + geom_point() +
    geom_point(aes(year, y = exp(intercept + trawling)), colour = "red") +
    geom_pointrange(aes(ymin = exp(intercept - (1.96 * SE)), ymax = exp(intercept + (1.96 * SE)))) + # using mean se on year effects
    ylim(min(exp(trawled$intercept - trawled$trawling - (1.96 * SE))), max(exp(trawled$intercept + trawled$trawling + (1.96 * SE)))) +
    ylab("Predicted kg/ha at mean depth") + ggtitle(names(depth_model_list[i]))
}
print(trawl_plots)
```




### Code for calculation SE on time-varying effects... 
```{r eval=FALSE}
# FIXME: need to add to sdmTMB!
r <- m$tmb_obj$report()
summary(m)
yrs <- sort(unique(m$data$year))
.sd <- summary(m$sd_report)
.sd <- as.data.frame(.sd)
.sd$par <- row.names(.sd)
.sd <- .sd[grepl("^b_rw_t", .sd$par), ]
varnames <- colnames(model.matrix(m$time_varying, m$data))

rep(varnames, each = length(yrs))
.sd$parameter <- rep(varnames, each = length(yrs))
.sd$year <- rep(seq_along(yrs), each = length(varnames))
row.names(.sd) <- NULL
.sd$par <- NULL

names(.sd$Estimate) <- "estimate"
names(.sd[2]) <- "se"
.sd$ci <- .sd$se * 1.96
m$time_varying


nrow(.sd)

b3 <- r$b_rw_t[, 3]
yrs <- sort(unique(m$data$year))
b_j <- m$tmb_params$b_j[1:8]

trawled <- data.frame(year = yrs, intercept = b_j, trawling = b3)
```


Get all biomass predictions 
#### Get all biomass predictions 
```{r, eval= FALSE, echo=FALSE, warning=FALSE}
priors <- FALSE
covariates <- "+muddy+any_rock"
covs <- gsub("\\+", "-", covariates)

rm(adult_predictions)
rm(imm_predictions)
rm(predictions)
pred_temp_do <- readRDS(here::here("analysis/tmb-sensor-explore/models/predicted-DO.rds"))

try({adult_predictions <- readRDS(paste0("data/", spp,
    "/all-predictions-", spp, covs, "-mat-biomass-prior-", priors, ".rds"
  ))%>% filter(year > 2007)
adult_predictions <- left_join(adult_predictions, pred_temp_do, c("X", "Y", "year", "ssid"))
})

try({imm_predictions <- readRDS(paste0("data/", spp,
    "/all-predictions-", spp, covs, "-imm-biomass-prior-", priors, ".rds"
  )) %>% filter(year > 2007)
imm_predictions <- left_join(imm_predictions, pred_temp_do, c("X", "Y", "year", "ssid"))
})

try({predictions <- readRDS(paste0("data/", spp,
    "/all-predictions-", spp, covs, "-total-biomass-prior-", priors, ".rds"
  ))%>% filter(year > 2007)
predictions <- left_join(predictions, pred_temp_do, c("X", "Y", "year", "ssid"))
})

if (!exists("adult_predictions")) adult_predictions <- NULL
if (!exists("imm_predictions")) imm_predictions <- NULL
if (!exists("predictions")) predictions <- NULL

biomass_list <- list(
  adult = adult_predictions,
  imm = imm_predictions,
  total = predictions
)

biomass_list <- biomass_list[!sapply(biomass_list, is.null)]

# 
# ggplot(biomass_list[[1]], aes(x = do_est, y = log(est_exp))) + 
#   geom_point(alpha = 0.3) #+ #geom_smooth()
#   geom_smooth(method = "lm", formula = y ~ x + I(x^2) , size = 1) #+ I(x^3)
```


