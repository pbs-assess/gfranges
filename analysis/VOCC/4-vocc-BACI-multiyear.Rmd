---
title: "BACI of biomass change for VOCC source cells for all years"
author: "Philina English"
date: '2019-08-24'
output: html_document
---

Modified to allow optimal temperature to vary by maturity class. 
Therefore need to run this file separately for each species-class combination.

Should matches be selected based on exact depth categories in addition to density (all within time periods)?

What does it mean for the analysis that the depth range at which VOCC occur within a species temperature range varies dramatically between time periods?


```{r global_options, include=FALSE}
knitr::opts_chunk$set(
  fig.width = 11, fig.height = 8.5,
  echo = FALSE, warning = FALSE, message = FALSE
)
options(scipen = 999)
options(digits = 4)
```

#### Set species
```{r echo=TRUE}
# # Species run so far...
 species <- "Arrowtooth Flounder"
# species <- "Pacific Cod"
# species <- "Sablefish"
# species <- "Silvergray Rockfish"
# species <- "Lingcod"
# species <- "North Pacific Spiny Dogfish" # note: using all data for maturity thresholds
# species <- "Quillback Rockfish"
# species <- "Pacific Ocean Perch"
# species <- "Yelloweye Rockfish"
```

#### Set age class
```{r echo=TRUE}
age <- "mature" # or mostly so
# age <- "imm"
```

#### Set vector type
```{r echo=TRUE}
 climate <- "temperature"
 temp_threshold <- c(0.5)

# climate <- "do"
# do_threshold <- c(0.5)
 
# climate <- "do and temperature"
```

#### Set Region 
```{r echo=TRUE}
# region <- "West Coast Vancouver Island"
region <- "both odd year surveys"
# region <- "West Coast Haida Gwaii"
```


#### Set default cell sizes and scale
```{r, echo=FALSE}
input_cell_size <- 2
dist_intercept <- input_cell_size/2
scale_fac <- 1
delta_t_step <- 2
skip_time <- NULL
```

Run all subsequent code...
```{r, include=FALSE}
library(dplyr)
library(ggplot2)
library(gfplot)
# library(gfdata)
library(sdmTMB)
# library(itsadug)
library(gfranges)
```

#### Get species-specific optimal values from mountain plots for most abundant year
```{r, include=FALSE}
spp <- gsub(" ", "-", gsub("\\/", "-", tolower(species)))

params <- readRDS(paste0("data/optimal-values-by-species-by-age.rds"))

if (age == "imm") {
  params <- filter(params, age == "imm")
} else {
  params <- filter(params, age != "imm")
}

params <- params[params$species == species, ] 

if (climate == "temperature") {
  optimal_temps <- params[rev(order(params$t_maxy)), ]$optimal_temp
  optimal_temps <- na.omit(optimal_temps)
  optimal_temp <- round(optimal_temps[1], digits = 2)
  variable_names <- c("temp")
  min_thresholds <- c(Inf)
  optimal_values <- optimal_temp
  max_thresholds <- temp_threshold
  indices <- c(1, 2)
  delta_t_total <- 2
  }

if (climate == "do") {
  optimal_dos <- params[rev(order(params$do_maxy)), ]$optimal_do
  optimal_dos <- na.omit(optimal_dos)
  optimal_do <- round(optimal_dos[1], digits = 2)
  variable_names <- c("do_est")
  max_thresholds <- c(Inf)
  optimal_values <- optimal_do
  min_thresholds <- do_threshold
  indices <- c(1, 2)
  delta_t_total <- 2
  }

if (climate == "do and temperature") {
  optimal_temps <- params[rev(order(params$t_maxy)), ]$optimal_temp
  optimal_temps <- na.omit(optimal_temps)
  optimal_temp <- round(optimal_temps[1], digits = 2)
  optimal_dos <- params[rev(order(params$do_maxy)), ]$optimal_do
  optimal_dos <- na.omit(optimal_dos)
  optimal_do <- round(optimal_dos[1], digits = 2)
  optimal_values <- c(optimal_do, optimal_temp)
  variable_names <- c("do_est", "temp")
  min_thresholds <- c(do_threshold, Inf)
  max_thresholds <- c(Inf, temp_threshold)
  indices <- c(1, 2)
  delta_t_total <- 2
  }

min_string <- paste0(min_thresholds, collapse = "-")
max_string <- paste0(max_thresholds, collapse = "-")

optimal_string <- paste0(optimal_values, collapse = "-")
climate_string <- gsub(" ", "-", gsub("\\/", "-", tolower(climate)))
```

```{r, message=FALSE, warning=FALSE, include=FALSE}
if (region == "both odd year surveys") {
  survey <- c("SYN QCS", "SYN HS")
  model_ssid <- c(1, 3)
  ssid_string <- paste0(model_ssid, collapse = "n")
  start_years <- list("2009"=2009, "2011"=2011, "2013"=2013, "2015"=2015) 
  # maybe remove 2011 & 2015 once we can add "2017"=2017?
  years <- NULL
}

if (region == "West Coast Vancouver Island") {
  survey <- c("SYN WCVI")
  model_ssid <- c(4)
  ssid_string <- paste0(model_ssid, collapse = "n")
  start_years <- list("2008"=2008, "2010"=2010, "2012"=2012, "2014"=2014, "2016"=2016) # prob need to remove 2010 & 2014
  years <- NULL
}

if (region == "West Coast Haida Gwaii") {
  survey <- c("SYN WCHG")
  model_ssid <- c(16)
  ssid_string <- paste0(model_ssid, collapse = "n")
  start_years <- list("2008"=2008, "2010"=2010, "2012"=2012, "2014"=2014, "2016"=2016) # prob need to remove 2010 & 2014
  years <- NULL
}
```

# Calculate climate vectors
```{r}
rm(vocc)

vocc_by_year <- lapply(start_years, function(start_time) {    

try({
  vocc <- readRDS(paste0(
    "data/vocc-", ssid_string, "-", climate_string, "-",
    min_string, "to", max_string, "-", start_time, "-", delta_t_total, ".rds"
  ))
})


if (!exists("vocc")) {
  pred_temp_do <- readRDS(here::here("analysis/tmb-sensor-explore/models/predicted-DO.rds"))

  if (length(variable_names) > 1) {
    climate_predictions <- replicate(length(variable_names), pred_temp_do, simplify = FALSE)
  } else {
    climate_predictions <- pred_temp_do
  }
  end_time <- start_time + 2
  vocc <- make_vector_data(climate_predictions,
    variable_names = variable_names,
    ssid = model_ssid,
    start_time = start_time,
    end_time = end_time,
    skip_time = skip_time,
    input_cell_size = input_cell_size,
    scale_fac = scale_fac,
    delta_t_total = delta_t_total,
    delta_t_step = delta_t_step,
    indices = indices,
    min_thresholds = min_thresholds,
    max_thresholds = max_thresholds,
    round_fact = 10
  )
  
  vocc$var_1_min <- min_thresholds[1]
  vocc$var_2_min <- min_thresholds[2]
  vocc$var_1_max <- max_thresholds[1]
  vocc$var_2_max <- max_thresholds[2]

  saveRDS(vocc, file = paste0(
    "data/vocc-", ssid_string, "-", climate_string, "-",
    min_string, "to", max_string, "-", start_time, "-", delta_t_total, ".rds"
  ))
}
 vocc
})  
# glimpse(vocc)
```

### Plot all possible vectors
```{r echo=FALSE}
all_vector_plots <- lapply(vocc_by_year, function(vocc) {    
start_time <- vocc$start_time[1]

if (climate == "temperature") {
  vocc$diff <- vocc$units_per_decade / 10 * delta_t_total

  vocc_plot <- plot_vocc(vocc,
    vec_aes = "distance",
    min_vec_plotted = input_cell_size,
    NA_label = ".",
    fill_col = "diff",
    fill_label = paste("Change from\n", start_time, "to", start_time + delta_t_total, ""),
    raster_alpha = 1,
    raster_limits = c(-4, 3),
    white_zero = TRUE,
    vec_alpha = 0.25,
    axis_lables = FALSE,
    transform_col = no_trans 
  ) + ggtitle(climate)
}

if (climate == "do") {
  vocc$diff <- vocc$units_per_decade / 10 * delta_t_total

  vocc_plot <- plot_vocc(vocc,
    vec_aes = "distance",
    min_vec_plotted = input_cell_size,
    NA_label = ".",
    fill_col = "diff",
    fill_label = paste("Change from\n", start_time, "to", start_time + delta_t_total, ""),
    raster_alpha = 1,
    white_zero = TRUE,
    high_fill = "Steel Blue 4",
    low_fill = "Red 3",
    vec_alpha = 0.25,
    axis_lables = FALSE,
    transform_col = no_trans 
  ) + ggtitle(climate)
}

if (climate == "do and temperature") {
  vocc$temp_diff <- vocc$temp.units_per_decade / 10 * delta_t_total

  vocc_plot_temp <- plot_vocc(vocc,
    vec_aes = "distance",
    min_vec_plotted = input_cell_size,
    NA_label = ".",
    fill_col = "temp_diff",
    fill_label = paste("Change from\n", start_time, "to", start_time + delta_t_total, ""),
    raster_alpha = 1,
    white_zero = TRUE,
    vec_alpha = 0.25,
    axis_lables = FALSE,
    transform_col = no_trans 
  ) + ggtitle("temperature")

  vocc$do_diff <- vocc$do_est.units_per_decade / 10 * delta_t_total

  vocc_plot_do <- plot_vocc(vocc,
    vec_aes = "distance",
    min_vec_plotted = input_cell_size,
    NA_label = ".",
    fill_col = "do_diff",
    fill_label = paste("Change from\n", start_time, "to", start_time + delta_t_total, ""),
    raster_alpha = 1,
    white_zero = TRUE,
    high_fill = "Steel Blue 4",
    low_fill = "Red 3",
    vec_alpha = 0.25,
    axis_lables = FALSE,
    transform_col = no_trans 
  ) + ggtitle("do")

  vocc_plot <- gridExtra::grid.arrange(
    vocc_plot_temp, vocc_plot_do,
    ncol = 2,
    top = grid::textGrob(paste("do of ", optimal_values[1], "less", min_thresholds[1], "or temperature of ", optimal_values[2], "plus", max_thresholds[2], " over ", start_time, "-", start_time + delta_t_total, ""))
  )
}
vocc_plot
})
print(all_vector_plots)
```

### Filter vectors to match optimal range for chosen species
```{r}

trimmed_vectors <- lapply(vocc_by_year, function(vocc) {    
#start_time <- vocc$start_time[1]

vectors <- trim_vector_data(vocc, variable_names, optimal_values, min_thresholds, max_thresholds,
  cell_size = input_cell_size, dist_intercept = dist_intercept,
  max_dist = 120
)
})

all_vectors <- do.call("rbind", trimmed_vectors)
```

### Plot remaining climate vectors for regions where change exceeds thresholds
```{r echo=FALSE, warning=FALSE}
if (climate == "temperature") {
all_vectors$diff <- all_vectors$units_per_decade / 10 * delta_t_total
raster_min <- min(all_vectors$diff)
raster_max <- max(all_vectors$diff)
}

if (climate == "do") {
all_vectors$diff <- all_vectors$units_per_decade / 10 * delta_t_total
raster_min <- min(all_vectors$diff)
raster_max <- max(all_vectors$diff)
}

if (climate == "do and temperature") {
  all_vectors$temp_diff <- all_vectors$temp.units_per_decade / 10 * delta_t_total
  all_vectors$do_diff <- all_vectors$do_est.units_per_decade / 10 * delta_t_total
  raster_min_temp <- min(all_vectors$temp_diff)
  raster_max_temp <- max(all_vectors$temp_diff)
  raster_min_do <- min(all_vectors$do_diff)
  raster_max_do <- max(all_vectors$do_diff)
}

trimmed_vector_plots <- lapply(trimmed_vectors, function(vectors) {    

try({ 
  
  start_time <- vectors$start_time[1]
  
  if (climate == "temperature") {
  vectors$diff <- vectors$units_per_decade / 10 * delta_t_total

  vocc_plot <- plot_vocc(vectors,
    vec_aes = "distance",
    min_vec_plotted = input_cell_size,
    NA_label = ".",
    fill_col = "diff",
    fill_label = paste("Change from\n", 
      start_time, "to", start_time + delta_t_total, ""),
    raster_alpha = 1,
    raster_limits = c(raster_min, raster_max),
    white_zero = TRUE,
    vec_alpha = 0.25,
    axis_lables = FALSE,
    transform_col = no_trans 
  ) + ggtitle(climate)
}

if (climate == "do") {
  vectors$diff <- vectors$units_per_decade / 10 * delta_t_total

  vocc_plot <- plot_vocc(vectors,
    vec_aes = "distance",
    min_vec_plotted = input_cell_size,
    NA_label = ".",
    fill_col = "diff",
    fill_label = paste("Change from\n", 
      start_time, "to", start_time + delta_t_total, ""),
    raster_alpha = 1,
    raster_limits = c(raster_min, raster_max),
    white_zero = TRUE,
    high_fill = "Steel Blue 4",
    low_fill = "Red 3",
    vec_alpha = 0.25,
    axis_lables = FALSE,
    transform_col = no_trans 
  ) + ggtitle(climate)
}

if (climate == "do and temperature") {
  vectors$temp_diff <- vectors$temp.units_per_decade / 10 * delta_t_total

  vocc_plot_temp <- plot_vocc(vectors,
    vec_aes = "distance",
    min_vec_plotted = input_cell_size,
    NA_label = ".",
    fill_col = "temp_diff",
    fill_label = paste("Change from\n", 
      start_time, "to", start_time + delta_t_total, ""),
    raster_alpha = 1,
    raster_limits = c(raster_min_temp, raster_max_temp),
    white_zero = TRUE,
    vec_alpha = 0.25,
    axis_lables = FALSE,
    transform_col = no_trans 
  ) + ggtitle("temperature")

  vectors$do_diff <- vectors$do_est.units_per_decade / 10 * delta_t_total

  vocc_plot_do <- plot_vocc(vectors,
    vec_aes = "distance",
    min_vec_plotted = input_cell_size,
    NA_label = ".",
    fill_col = "do_diff",
    fill_label = paste("Change from\n", 
      start_time, "to", start_time + delta_t_total, ""),
    raster_alpha = 1,
    raster_limits = c(raster_min_do, raster_max_do),
    white_zero = TRUE,
    high_fill = "Steel Blue 4",
    low_fill = "Red 3",
    vec_alpha = 0.25,
    axis_lables = FALSE,
    transform_col = no_trans 
  ) + ggtitle("do")

  vocc_plot <- gridExtra::grid.arrange(
    vocc_plot_temp, vocc_plot_do,
    ncol = 2,
    top = grid::textGrob(paste(
      "DO of ", optimal_values[1], "less", min_thresholds[1], 
      "or temperature of ", optimal_values[2], "plus", max_thresholds[2], 
      " over ", start_time, "-", start_time + delta_t_total, ""))
  )
}
vocc_plot
})
})

print(trimmed_vector_plots)
```
# Add species biomass data

Get all biomass predictions 
```{r, echo=FALSE, warning=FALSE, error=FALSE, message=F}
priors <- FALSE
covariates <- "+muddy+any_rock"
covs <- gsub("\\+", "-", covariates)

rm(biomass_predictions)

if (age == "imm") {
  try({
  biomass_predictions <- readRDS(paste0(
    "data/", spp,
    "/all-predictions-", spp, covs, "-imm-biomass-prior-", priors, ".rds"
  ))
})
} else {
try({
  biomass_predictions <- readRDS(paste0(
    "data/", spp,
    "/all-predictions-", spp, covs, "-mat-biomass-prior-", priors, ".rds"
  ))
})
if (!exists("biomass_predictions")) {
try({
  biomass_predictions <- readRDS(paste0(
    "data/", spp,
    "/all-predictions-", spp, covs, "-total-biomass-prior-", priors, ".rds"
  ))
})
}
}
```

Extract biomass values to match spatial and temporal range of climate vectors
```{r}
#alldata <- lapply(biomass_list, function(biomass_predictions) {
 
  biomass_by_year <- list()
  for (j in seq_along(start_years)) {
   start_time <- start_years[[j]]
   end_time <- start_time + 2 
 
   biomass_by_year[[j]] <- make_trend_data(biomass_predictions,
    ssid = model_ssid,
    start_time = start_time,
    skip_time = skip_time,
    end_time = end_time,
    input_cell_size = input_cell_size,
    scale_fac = scale_fac,
    delta_t_total = delta_t_total,
    delta_t_step = delta_t_step,
    indices = indices,
    variable_names = "est_exp"
  )
  }
 
  biomass_change <- do.call("rbind", biomass_by_year)
   
  biomass_covs <- biomass_predictions %>% 
    select(X, Y, depth, trawled, muddy, any_rock, omega_s) %>% 
    distinct()
  
  biomass_change <- biomass_change %>% 
    rename(start_density = est_exp_s, end_density = est_exp_e) %>%
    dplyr::select(icell, x, y, start_time, start_density, end_density)
    # dplyr::select(-N, -time_step, - units_per_decade, -slope)
  
  biomass <- left_join(biomass_change, biomass_covs, by = c("x" = "X", "y"="Y")) 

  # keep just one row for each cell that exceeded the end climate threshold 
  source_cells <- all_vectors %>% filter(distance > (-dist_intercept)) %>% 
    distinct(icell, start_time, .keep_all = TRUE) %>% 
    select(-target_X, -target_Y, -target_values, -tid)

  source_biomass <- left_join(source_cells, biomass, 
    by = c("icell", "x", "y", "start_time")) %>%
    mutate(cell_type = "source") %>% filter(!is.na(start_density))
  
  # identify all possible control cells have been given a distance == - dist_intercept
  control_cells <- all_vectors %>% filter(distance == (-dist_intercept)) %>% 
    distinct(icell, start_time, .keep_all = TRUE) %>% 
    mutate(distance = (- dist_intercept)) %>% 
    select(-target_X, -target_Y, -target_values, -tid)

  control_biomass <- left_join(control_cells, biomass, 
    by = c("icell", "x", "y", "start_time")) %>%
    mutate(cell_type = "control") %>% filter(!is.na(start_density))

  alldata <- rbind(source_biomass, control_biomass) 
  alldata <- mutate(alldata, treat = ifelse(cell_type=="source", 1, 0)) %>% 
    select(-var_2_min, -var_2_max, -mean_target_X, -mean_target_Y) %>% 
    rename(vect_dist = distance)
  alldata$treat <- as.factor(alldata$treat)
  
  alldata
#})
```

```{r eval=FALSE, include=FALSE, echo=FALSE}
# lapply(alldata, function(i){ggplot(i, aes(x=cell_type, y=log(start_density))) + geom_boxplot()+facet_wrap(~start_time)})
```


# Select matched control cells
```{r}
rm(vocc_by_sp)
try({
  vocc_by_sp <- readRDS(paste0(
    "data/ BACI-", species, "-", age, "-", ssid_string, "-", climate_string, "-",
    min_string, "to", max_string, "-multiyear-all.rds"
  ))
})

match_formula <- paste0("treat ~ 
  muddy.st + any_rock.st + x + y") #depth.st + trawled + omega_s + 
  # for (j in (variable_names)) {
  #   fit_formula <- paste0("", fit_formula, " + ", j, "_s")
  #   }

if (!exists("vocc_by_sp")){
# matched <- lapply(alldata, function(alldata) {  

  ## trim non-overlapping values to reduce size of dataset 
  control_min <- quantile(alldata$start_density[alldata$treat=="0"], 0.01)
  source_min <- quantile(alldata$start_density[alldata$treat=="1"], 0.01)
  # control_max <- quantile(alldata$start_density[alldata$treat=="0"], 1)
  # source_max <- quantile(alldata$start_density[alldata$treat=="1"], 1)

  group_min <- max(control_min, source_min)
  # group_max <- min(control_max, source_max)
  alldata <- filter(alldata, start_density >= group_min) 
  #%>% filter(start_density <= group_max)
  
  # need to be standardized? seems not
  alldata$depth2 <- alldata$depth^2
  alldata$start_density.st <- round(arm::rescale(log(alldata$start_density))*5)/5
  alldata$depth.st <- round(arm::rescale(log(alldata$depth))*5)/5
  alldata$muddy.st <- arm::rescale(alldata$muddy) 
  alldata$any_rock.st <- arm::rescale(alldata$any_rock) 
  #alldata$omega_s.st <- arm::rescale(alldata$omega_s) 
  
 ## Using optimization ... doesn't work   
  # alldata$start_density_st <- round(arm::rescale(log(alldata$start_density)), 1)
  # fit_formula <- 
  #   paste0("treat ~ start_density_st + depth.st + muddy.st + any_rock.st") 
  # # for (j in (variable_names)) {
  # #   fit_formula <- paste0("", fit_formula, " + ", j, "_s")
  # #   }
  # # options("optmatch_max_problem_size" = Inf)
  # matched <- MatchIt::matchit(as.formula(fit_formula), 
  #     method = "optimal", data = alldata)
  
  # # Using exact match and rounding
  # # Choose data order if not using random
  # alldata <- alldata[(order(alldata$y)), ]
  # if (order == "increasing") alldata <- alldata[rev(order(alldata$start_density)), ]
  # if (order == "decreasing") alldata <- alldata[rev(order(alldata$start_density)), ]

  matched <- MatchIt::matchit(as.formula(match_formula), 
    exact = c("start_density.st", "start_time", "depth.st"),
    method = "nearest", m.order = "random",
    distance = "probit",
    discard="both",
    data = alldata)
  # matched
# })
}
```

Print diagnostics for matching
```{r echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
if (!exists("vocc_by_sp")){
match_plots <- apply(matched, function(matched){  
  summary(matched)
  plot(matched)
 })
match_plots
}
```

Prep matched data for analysis
```{r}
if (!exists("vocc_by_sp")){
#vocc_by_sp <- lapply(matched, function(matched) {    
  mdata <- MatchIt::match.data(matched, distance = "pscore")
  
  sources <- mdata[row.names(matched$match.matrix), ]
  sources$origobs <- row.names(sources)   
  sources$matchobs <- matched$match.matrix[,1]  
  
  controls <- mdata[matched$match.matrix, ]
  controls$origobs <- row.names(controls)   
  controls$matchobs <- matched$match.matrix[,1]  
 
  mdata <- rbind(sources, controls) %>% tidyr::drop_na() %>% filter(matchobs!="-1")
  
  matched_time0 <- mdata %>% mutate(after = 0, density = start_density) 
  #%>% dplyr::select(-start_density, -end_density)
  matched_time1 <- mdata %>% mutate(after = 1, density = end_density) 
  #%>% dplyr::select(-start_density, -end_density)
 
  for (j in seq_along(variable_names)) {
    climate <- paste0(variable_names[j])
    matched_time0 <- matched_time0 %>% 
      mutate((!!climate) := (UQ(rlang::sym(paste0(variable_names[j], "_s")))))
    matched_time1 <- matched_time1 %>% 
      mutate((!!climate) := (UQ(rlang::sym(paste0(variable_names[j], "_e")))))
   }
  
  vocc_by_sp <- rbind(matched_time0, matched_time1)
  
  # calculate standardized climate variables
  for (j in seq_along(variable_names)) {
    mean.var <- paste0("mean.", variable_names[j])
    sd.var <- paste0("sd.", variable_names[j])
    std.var <- paste0("std_", variable_names[j])
    std.var2 <- paste0("std_", variable_names[j], "2")

    vocc_by_sp <- mutate(
      vocc_by_sp,
      (!!mean.var) := mean(UQ(rlang::sym(paste0(variable_names[j]))), na.rm = TRUE),
      (!!sd.var) := sd(UQ(rlang::sym(paste0(variable_names[j]))), na.rm = TRUE),
      (!!std.var) := ((UQ(rlang::sym(paste0(variable_names[j]))) - 
          mean(UQ(rlang::sym(paste0(variable_names[j]))), na.rm = TRUE)) / 
          (sd(UQ(rlang::sym(paste0(variable_names[j]))), na.rm = TRUE))*2),
      (!!std.var2) := (( UQ(rlang::sym(paste0(variable_names[j]))) - 
          mean(UQ(rlang::sym(paste0(variable_names[j]))), na.rm = TRUE) ) / 
          (sd(UQ(rlang::sym(paste0(variable_names[j]))), na.rm = TRUE)*2))^2
    )
  }

  # rename spatial coordinates to avoid naming conflict with y~x notation
  data <- vocc_by_sp %>%
    rename(X = x, Y = y)
    # %>% rename(distance = vect_dist) %>% 
    # select(-start_density.st, -depth.st, -muddy.st, -any_rock.st, -omega_s.st)
  
  # other variable prep
  data$log_density <-  log(data$density)
  data$log_depth <-  log(data$depth)
  data$std_log_depth <- arm::rescale(log(data$depth))
  data$vect_dist2 <- data$vect_dist^2
  data <- mutate(data, time = ifelse(after==1, "end", "begin"))
  data$matchobs <- as.factor(data$matchobs)
  data$origobs  <- as.factor(data$origobs)   
  data$start_time <- as.factor(data$start_time)
  
#  data
#})
vocc_by_sp <- list()
vocc_by_sp[[1]] <- data
vocc_by_sp[[3]] <- match_formula  
vocc_by_sp[[4]] <- match_plots
saveRDS(vocc_by_sp, file = paste0(
    "data/ BACI-", species, "-", age, "-", ssid_string, "-", climate_string, "-",
    min_string, "to", max_string, "-multiyear-all.rds"
  ))
}
```


```{r}
try({
  vocc_by_sp <- readRDS(paste0(
    "data/ BACI-", species, "-", age, "-", ssid_string, "-", climate_string, "-",
    min_string, "to", max_string, "-multiyear-all.rds"
  ))
})
data <- vocc_by_sp [[1]]
# View(data)
```

### Plot matches
```{r}
dat_summary <- data %>% 
  group_by(start_time, cell_type) %>%
  tally() %>% filter(cell_type=="source")
data_depth <- data %>% 
  group_by(start_time) %>% 
  mutate(mean_depth = mean(depth)) 


ggplot(data, 
#ggplot(filter(data, as.numeric(matchobs) <= 550), 
  aes(y=Y, x=X, shape=as.factor(treat), colour=as.factor(matchobs))) +
  geom_point(alpha=0.8, size = 1) +
  scale_shape_manual(values= c(0, 15)) +
  scale_colour_viridis_d(option="C", guide = FALSE) +
  facet_wrap(~start_time) +
  theme_bw()

lapply(variable_names, function(j) {
ggplot(data, aes(y=log_density, x=UQ(rlang::sym(paste(j))), colour=time)) +
  geom_point(alpha=0.35) +
  scale_colour_viridis_d(option="C") +
  facet_grid(start_time~cell_type) +
  theme_bw()
})
 
ggplot(data, aes(std_log_depth, fill = cell_type)) +
  geom_density(alpha=0.5) +
  scale_fill_viridis_d(option="C") +
  facet_wrap(~start_time) +
  theme_bw()
#  
# ggplot(data, aes(y=log_density, x=depth, colour=cell_type)) +
#   geom_point(alpha=0.35) +
#   scale_colour_viridis_d(option="C") +
#     facet_grid(start_time~time) +
#   theme_bw()

ggplot(data, aes(log_density, fill = cell_type)) +
  geom_density(alpha=0.5) +
  scale_fill_viridis_d(option="C") +
  facet_grid(start_time~time, scales = 'fixed') +
  theme_bw()

ggplot(data, aes(log_density, fill = cell_type)) +
  geom_histogram(alpha=0.45) +
  scale_fill_viridis_d(option="C") +
  facet_grid(time~start_time) +
  theme_bw()

dat_summary <- data %>% 
  group_by(start_time, cell_type) %>% 
  tally() %>% filter(cell_type=="source")

ggplot(data, aes(y=log_density, x=cell_type, fill=cell_type)) +
  geom_boxplot(alpha=0.5) +
  scale_fill_viridis_d(option="C") +
  geom_text(data = dat_summary,
            aes(cell_type, max(data$log_density)-1, label = n), hjust = -0.3) +
  facet_grid(time~start_time) +
  theme_bw()
```

### Basic BACI
```{r}
for (j in (variable_names)) {
  baci_formula <- paste0("log_density~after + cell_type + after:cell_type + n_targets + vect_dist + vect_dist2 + std_", j, "+ std_", j, "2 + (1|icell) + (1|matchobs) + (1|start_time)")
}

m <- lmerTest::lmer(as.formula(baci_formula), data=data)
summary(m)
```


```{r}
sjPlot::plot_model(m, type = "std2", order.terms=c(1,2,8,3,4,5,6,7), title = paste(species, "adult"))
```

### GAMM
```{r}
 gamm_formula <- paste0("log_density ~ ", 
  # "time * start_time + ",
  #"start_time * cell_type + ",
  "time * cell_type + s(vect_dist) + s(std_log_depth) + s(X,Y)")

for (j in (variable_names)) {
 gamm_formula <- paste0(gamm_formula, "+ s(std_", j, ")")
 }

gam4 <- gamm4::gamm4(as.formula(gamm_formula), 
  random = ~(1|matchobs) + (1|icell) 
   + (1|start_time)
  # + (time|start_time) 
  # + (cell_type|start_time)
  , data=data) 

summary(gam4$gam) 

plot(gam4$gam,pages=1)
```

```{r, eval=FALSE, results="hide", include=FALSE}
plot_parametric(gam4$gam, pred=list(time=c("begin","end"), cell_type=c("control", "source"), start_time=c("2009","2011","2013","2015")), parametricOnly = TRUE, main="", xlab ="log_density"
  #, groups = cell_type, gcolor = my_cols, color = my_cols["time"]
  ) 
```

