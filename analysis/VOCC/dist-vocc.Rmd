---
title: "Distanced-based VOCC analysis"
author: "Philina English"
date: '2019-05-14'
output: html_document
---


```{r setup, include=FALSE}
# install.packages("yaImpute") # install package for k-nearest neighbour (kNN) search
# install.packages("raster") # required for calcslope + all raster functions
# install.package(gfplot) # required for some plotting and data functions

library(dplyr)
library(ggplot2)
library(sdmTMB)
library(gfranges)
```

Retrieve raw data
```{r}
all_depth <- readRDS("../tmb-sensor-explore/data/dat-sensor-trawl-all-depth.rds")

# add and scale predictors after filtering for survey(s) of interest
data <- all_depth$data %>%
  filter(depth_max>10) %>% # removes data if sensor stayed too near surface
  # filter(ssid != 1) %>%
  # filter(ssid != 3) %>%
  # filter(ssid != 4) %>%
  # filter(ssid != 16) %>%
  gfplot:::scale_survey_predictors()

data <- data[data$fishing_event_id != 481861, ]
# add any new predictors
# data <- data %>%
#   dplyr::mutate(
#   DOY = lubridate::yday(date),
#   shallow = ifelse(depth > 35, 0, 1)
# )
```

Or use old data 
```{r eval=FALSE}
data <- readRDS("../tmb-sensor-explore/data/sensor-data-processed.rds")
data <- data %>% mutate(depth = depth_m) %>% 
  filter(depth_m >10) %>% # removes data if sensor stayed too near surface
  gfplot:::scale_survey_predictors()

data <- data[data$fishing_event_id != 481861, ]
```


Create prediction grids for each survey area so that only years with data are included
```{r}
# choose base year(s) to create grid from
dummy_year <- c(2004, 2005)

# create grids for each ssid separately 
ssid <- 1
survey_abbrev <- "SYN QCS"
nd_1 <- spatiotemporal_grid(data, ssid, survey_abbrev, dummy_year)
unique(nd_1$year)

ssid <- 3
survey_abbrev <- "SYN HS"
nd_3 <- spatiotemporal_grid(data, ssid, survey_abbrev, dummy_year)
unique(nd_3$year)

ssid <- 4
survey_abbrev <- "SYN WCVI"
nd_4 <- spatiotemporal_grid(data, ssid, survey_abbrev, dummy_year)
unique(nd_4$year)

ssid <- 16
survey_abbrev <- "SYN WCHG"
nd_16 <- spatiotemporal_grid(data, ssid, survey_abbrev, dummy_year = 2006)
unique(nd_16$year)

nd <- rbind(nd_1, nd_3, nd_4, nd_16)
nd <- nd %>% dplyr::mutate(shallow = ifelse(depth > 35, 0, 1))
```

Run sdmTMB model (if not done previously).
```{r eval=FALSE}
# # choose the spatial range to model
dat <- data %>% dplyr::filter(year > 2003) #%>% select(year, ssid, X, Y, temperature_c, depth_scaled, depth_scaled2)
nd <- nd #%>% filter(ssid == 4)
 
spde <- sdmTMB::make_spde(dat$X, dat$Y, n_knots = 500)
sdmTMB::plot_spde(spde)

m_temp <- sdmTMB::sdmTMB(dat,
  temperature_c ~ 0 + as.factor(year),
  time_varying = ~ 0 + depth_scaled + depth_scaled2,
  time = "year", spde = spde,
  family = gaussian(link = "identity"),
  ar1_fields = TRUE, # maybe TRUE is better for all areas combined?
  include_spatial = TRUE,
  silent = FALSE
)

# stopifnot(m_temp$model$convergence == 0L)
# m_temp
# # Warning messages:
# #   1: In doTryCatch(return(expr), name, parentenv, handler) :
# #   restarting interrupted promise evaluation
# 
# saveRDS(m_temp, file = "data/m_temp_post2003.rds")
saveRDS(m_temp, file = "data/m_temp_allyears.rds")
```

Calculate predicted values
```{r}
m_temp <- readRDS("../VOCC/data/m_temp_allyears.rds")

# can also be filtered to exclude certain years
# m_temp <- readRDS("../VOCC/data/m_temp_allpost2003.rds")
# nd <- nd %>% dplyr::filter(year > 2003)


predictions <- predict(m_temp, newdata = nd)

plot_map <- function(dat, column = "est") {
  ggplot(dat, aes_string("X", "Y", fill = column)) +
    geom_raster() +
    facet_wrap(~year) +
    coord_fixed()
}

p <- plot_map(predictions , "est") +
  scale_fill_viridis_c(trans = "sqrt", option = "C") +
  ggtitle("Prediction (fixed effects + all random effects)")
print(p)
```

Explore subsets ot the spatial range 
```{r eval=FALSE}
predicted1 <- predictions %>% filter(ssid == 1) 
predicted3 <- predictions %>% filter(ssid == 3) 
predicted4 <- predictions %>% filter(ssid == 4) 
predicted16 <- predictions %>% filter(ssid == 16) 
predicted1n3 <- predictions %>% filter(ssid != 16) %>% filter(ssid != 4) %>% filter(year > 2004) 

p <- plot_map(predicted1n3 , "est") +
  scale_fill_viridis_c(trans = "sqrt", option = "C") +
  ggtitle("Prediction (fixed effects + all random effects)")
print(p)
```


```{r}
out <- make_vector_data (predictions, 
  ssid = c(1),
  start_year = 2005,
  input_cell_size = 2, 
  scale_fac = 2,
  delta_t_total = 10,
  delta_t_step = 2,
  time_steps = 7,
  indices = c(1, 1, 1, 2, 3, 3, 3),
  thresholds = c(0.5) # vector of plus/minus threshold(s) to define climate match.
  )
glimpse(out)
```


```{r}
gvocc <- plot_vocc(out,
  low_col = "white",
  mid_col = "white",
  high_col = "grey97", 
  vec_aes = "distance",
  vec_lwd_range = c(0.5,0.6),
  max_vec_plotted = 100,
  fill_col = "var_1_s",
  fill_label = "Mean\ntemperature\n2005 & 2007",
  raster_alpha = 1,
  vec_alpha = 0.8
)
gvocc
```

```{r}
gtrend <- plot_vocc(out,
  fill_col = "C_per_decade",
  fill_label = "Temperature\ntrend (Â°C/decade)\nfor 2005-2017",
  raster_alpha = 1,
  vec_aes = NULL
)
gtrend
```

```{r}
# png(file = "accasp-wg-fig.png",   # The directory you want to save the file in
# res = 600,
# units = 'in',
# width = 10, # The width of the plot in inches
# height = 7) # The height of the plot in inches

gridExtra::grid.arrange(gtrend, gvocc, nrow = 1)
#dev.off()
```

