---
title: "`r paste(params$species)` climatic and biotic velocities for `r paste(params$region)` (immature: `r paste(params$immature)`"
author: "Philina English"
date: "`r Sys.Date()`"
output: html_document 
params: 
    # species: "Redbanded Rockfish"
    # species: "Canary Rockfish"
    species: "English Sole"
    # species: "Dover Sole"
    # species: "Flathead Sole"
    # species: "Sablefish"
    # species: "Arrowtooth Flounder"
    immature: FALSE
    # region: "West Coast Vancouver Island"
    region: "both odd year surveys"
    # region: "West Coast Haida Gwaii"
    covs: "-tv-depth-only"
    scrambled_years: FALSE
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(
  fig.keep = "all", fig.show = "asis", dpi = 600,
  fig.width = 6, fig.height = 5,
  echo = FALSE, warning = FALSE, message = FALSE
)
options(scipen = 999)
options(digits = 4)
```

```{r pkgs, cache=FALSE, warning=FALSE, message=FALSE}
library("gfranges")
library("dplyr")
library("ggplot2")

ggplot2::theme_set(gfplot::theme_pbs())
```

#### Set parameters
```{r }
species <- params$species
region <- params$region
covs <- params$covs
immature <- params$immature
scrambled_years <- params$scrambled_years

spp <- gsub(" ", "-", gsub("\\/", "-", tolower(species)))

paste("species =", species)
paste("region =", region)
paste("covs =", covs)
paste("scrambled =", scrambled_years)
```


#### Set cell sizes and scale
```{r, echo=TRUE}
dist_intercept <- 0 # input_cell_size / 2
input_cell_size <- 2
scale_fac <- 2 # means that the raster is reprojected to _ X original grid (2 km)
```

```{r, message=FALSE, warning=FALSE, include=FALSE}
if (region == "both odd year surveys") {
  survey <- c("SYN QCS", "SYN HS")
  model_ssid <- c(1, 3)
  ssid_string <- paste0(model_ssid, collapse = "n")
  start_year <- 2008
}

if (region == "West Coast Vancouver Island") {
  survey <- c("SYN WCVI")
  model_ssid <- c(4)
  ssid_string <- paste0(model_ssid, collapse = "n")
  start_year <- 2008
}

if (region == "West Coast Haida Gwaii") {
  survey <- c("SYN WCHG")
  model_ssid <- c(16)
  ssid_string <- paste0(model_ssid, collapse = "n")
  start_year <- 2008
}
```

#### Get species-specific optimal values from mountain plots for most abundant year
```{r, include=FALSE}
if (immature) {
  age <- "immature"
  d_all <- readRDS(paste0(
    "data/", spp,
    "/predictions-", spp, covs, "-1n3n4n16-imm-biomass-prior-FALSE.rds"
  )) %>% filter(year >= start_year )
} else {
  age <- "mature"
  try({
    d_all <- readRDS(paste0(
      "data/", spp,
      "/predictions-", spp, covs, "-1n3n4n16-total-biomass-prior-FALSE.rds"
    )) %>% filter(year >= start_year )
  })
  try({
    d_all <- readRDS(paste0(
      "data/", spp,
      "/predictions-", spp, covs, "-1n3n4n16-mature-biomass-prior-FALSE.rds"
    )) %>% filter(year >= start_year )
  })
}
# hist(d_all$log_effort)
```

#### SET TIME FRAME
```{r}
multiyear <- TRUE

if (multiyear) {
  # unique(d_all$year)
  d <- d_all %>% filter(ssid %in% model_ssid)
  length(unique(d$year))
  years_sampled <- length(unique(d$year))
  year_range <- (years_sampled - 1) * 2

  # current version of this model
  if (years_sampled == 5) indices <- c(1, 2, 2, 2, 2)
  if (years_sampled == 6) indices <- c(1, 2, 2, 2, 2, 2)
  
  # should try running with gradient based on only later years?
  if (years_sampled == 5) indices <- c(1, 1, 2, 2, 2)
  if (years_sampled == 6) indices <- c(1, 1, 1, 2, 2, 2)
  
  
} else {
  d <- d_all %>%
    filter(year >= start_year) %>%
    filter(year <= start_year + 3)
  unique(d$year)
  indices <- c(1, 2)
  year_range <- 2
}

skip_time <- NULL
delta_t_step <- year_range
delta_t_total <- year_range

glimpse(d)


if (scrambled_years) {
  d2 <- list()
  # set.seed(9999)
  # set.seed(12345)
  # set.seed(98765)
  original_years <- unique(d$year)
  new_years <- sample(original_years, replace = F)
  convert <- cbind(original_years, new_years)
  convert
  for (i in seq_len(length(original_years))) {
    old_year <- as.integer(convert[[i, 1]])
    fake_year <- as.integer(convert[[i, 2]])
    d2[[i]] <- filter(d, year == old_year) %>%
      mutate(year = fake_year)
    # browser()
  }
  d <- do.call(rbind, d2)
  convert
}
```

#### TRIM environment to range sampled
```{r}
nd_all <- readRDS(paste0("data/predicted-DO-new.rds")) %>% select(X, Y, year, temp, do_est)
fishing <- readRDS("data/_fishing_effort/fishing-effort-grid.rds")
# fishing <- readRDS("data/fishing-effort-grid-6hr.rds")

d <- left_join(d, nd_all, by = c("X", "Y", "year"))
d <- left_join(d, fishing, by = c("X", "Y", "year"))
d$log_effort[is.na(d$log_effort)] <- -2.3

glimpse(d)

# d <- d %>% filter(do_est > 0.23) %>% filter(do_est < 7.91) # full range
d <- d %>%
  filter(do_est > 0.28) %>%
  filter(do_est < 7.06) # 0.005 and 0.995
# d <- d %>% filter(temp > 2.61) %>% filter(temp < 14.31) # full range
d <- d %>%
  filter(temp > 3.07) %>%
  filter(temp < 11.3) # 0.005 and 0.995
```

Calculate mean and trend in log fishing pressure
```{r }
gf <- vocc_gradient_calc(d, "log_effort",
  scale_fac = scale_fac,
  # all layers with max indice will be averaged for spatial gradient
  # if default (NULL) will use all years
  # indices = indices,
  divisor = 1,
  quantile_cutoff = 0.05
)

gf <- gf %>%
  mutate(
    fishing_trend = trend,
    mean_effort = exp(mean)
  ) %>%
  dplyr::mutate(X = x, Y = y) %>%
  gfplot:::utm2ll(., utm_zone = 9)

gf$squashed_effort <- collapse_outliers(gf$mean_effort, c(0, 0.95))


# fished <- gf %>%
#   select(x, y, fishing_trend, mean_effort)
# saveRDS(fished, file = paste0("data/fishing-effort-trend-6hr-", ssid_string, ".rds"))
```

```{r eval = F}

effort <- plot_vocc(gf,
  # theme_black = TRUE,
  coast = TRUE,
  vec_aes = NULL,
  # grad_vec_aes = "velocity",
  # vec_lwd_range = c(0.5, 0.5),
  # NA_label = "NA",
  fill_col = "squashed_effort",
  fill_label = "mean effort",
  raster_alpha = 1,
  # raster_limits = c(raster_min, raster_max),
  na_colour = "white",
  # high_fill = "Steel Blue 4",
  # low_fill = "Red 3",
  # white_zero = TRUE,
  vec_alpha = 0.35,
  axis_lables = FALSE,
  transform_col = fourth_root_power #
) + labs(
  title = "Fishing presssure",
  subtitle = paste0(min(d$year), "-", max(d$year))
)

effort

fish_t <- plot_vocc(gf,
  # theme_black = TRUE,
  coast = TRUE,
  vec_aes = NULL,
  # grad_vec_aes = "velocity",
  # vec_lwd_range = c(0.5, 0.5),
  # NA_label = "NA",
  fill_col = "fishing_trend",
  fill_label = "trend in fishing effort",
  raster_alpha = 1,
  # raster_limits = c(raster_min, raster_max),

  # high_fill = "Steel Blue 4",
  # low_fill = "Red 3",
  # white_zero = TRUE,
  vec_alpha = 0.35,
  axis_lables = FALSE,
  transform_col = sqrt # no_trans #
) + labs(
  title = "Fishing presssure",
  subtitle = paste0(min(d$year), "-", max(d$year))
)

fish_t

```

# Calculate climate velocity
### Dissolved Oxygen
```{r }
gf0 <- vocc_gradient_calc(d, "do_est",
  scale_fac = scale_fac,
  # all layers with max indice will be averaged for spatial gradient
  # if default (NULL) will use all years
  # indices = indices,
  divisor = 1,
  quantile_cutoff = 0.05
)

gf0 <- gf0 %>%
  mutate(
    trend_per_year = trend,
    trend_per_decade = trend_per_year * 10,
    velocity = velocity
  ) %>%
  dplyr::mutate(X = x, Y = y) %>%
  gfplot:::utm2ll(., utm_zone = 9)
```


```{r eval=F}
gf0$squashed_velocity <- collapse_outliers(gf0$velocity, c(0.005, 0.995))

grad0v <- plot_vocc(gf0,
  # theme_black = TRUE,
  coast = TRUE,
  vec_aes = NULL,
  # grad_vec_aes = "velocity",
  # vec_lwd_range = c(0.5, 0.5),
  NA_label = "NA",
  fill_col = "squashed_velocity",
  fill_label = "DO velocity",
  raster_alpha = 1,
  # raster_limits = c(raster_min, raster_max),
  na_colour = "white",
  high_fill = "Steel Blue 4",
  low_fill = "Red 3",
  white_zero = TRUE,
  vec_alpha = 0.35,
  axis_lables = FALSE,
  transform_col = no_trans # fourth_root_power
) + labs(
  title = "do velocity",
  subtitle = paste0(min(d$year), "-", max(d$year))
)

grad0v
```


```{r eval=F}
grad0 <- plot_vocc(gf0,
  # theme_black = TRUE,
  coast = TRUE,
  vec_aes = NULL,
  # grad_vec_aes = "velocity",
  # vec_lwd_range = c(0.5, 0.5),
  NA_label = "NA",
  fill_col = "trend",
  fill_label = "DO trend",
  raster_alpha = 1,
  # raster_limits = c(raster_min, raster_max),
  na_colour = "black",
  high_fill = "Steel Blue 4",
  low_fill = "Red 3",
  white_zero = TRUE,
  vec_alpha = 0.35,
  axis_lables = FALSE,
  transform_col = no_trans #
) + labs(
  title = "do trend",
  subtitle = paste0(min(d$year), "-", max(d$year))
)

grad0
```



### Temperature
```{r}
gf2 <- vocc_gradient_calc(d, "temp",
  scale_fac = scale_fac,
  # all layers with max indice will be averaged for spatial gradient
  # if default (NULL) will use all years
  # indices = indices,
  divisor = 1,
  quantile_cutoff = 0.05
)

gf2 <- gf2 %>%
  mutate(
    trend_per_year = trend,
    trend_per_decade = trend_per_year * 10,
    velocity = velocity
  ) %>%
  dplyr::mutate(X = x, Y = y)
```

```{r eval=F}
gf2$squashed_velocity <- collapse_outliers(gf2$velocity, c(0.005, 0.995))

grad2v <- plot_vocc(gf2,
  # theme = "black",
  coast = TRUE,
  vec_aes = NULL,
  # grad_vec_aes = "velocity",
  # vec_lwd_range = c(0.5, 0.5),
  NA_label = "NA",
  fill_col = "squashed_velocity",
  fill_label = "temperature \nvelocity",
  raster_alpha = 1,
  # raster_limits = c(raster_min, raster_max),
  na_colour = "white",
  white_zero = TRUE,
  vec_alpha = 0.35,
  axis_lables = FALSE,
  transform_col = no_trans # fourth_root_power # sqrt #
) + labs(
  title = "temp velocity",
  subtitle = paste0(min(d$year), "-", max(d$year))
)

grad2v
```

```{r eval=F}
grad2 <- plot_vocc(gf2,
  # theme = "black",
  coast = TRUE,
  vec_aes = NULL,
  # grad_vec_aes = "velocity",
  # vec_lwd_range = c(0.5, 0.5),
  NA_label = "NA",
  fill_col = "trend",
  fill_label = "temperature \ntrend",
  raster_alpha = 1,
  # raster_limits = c(raster_min, raster_max),
  na_colour = "white",
  white_zero = TRUE,
  vec_alpha = 0.35,
  axis_lables = FALSE,
  transform_col = no_trans # log10 # fourth_root_power # sqrt #
) + labs(
  title = "temp trend",
  subtitle = paste0(min(d$year), "-", max(d$year))
)

grad2
```

### Gradient-based BIOTIC VECTORS
```{r}
# indices <- c(1,2,3,4,5)

gf3 <- vocc_gradient_calc(d, "est",
  scale_fac = scale_fac,
  # indices = indices,
  divisor = 1,
  log_space = TRUE,
  quantile_cutoff = 0.025
)

gf3 <- gf3 %>%
  mutate(
    CV_formula = sqrt(exp(cv^2) - 1),
    CV = sd / exp(mean),
    mean_biomass = exp(mean) * 10000,
    # trend_per_year = exp(trend),
    # trend_per_decade = trend_per_year * 10,
    velocity = velocity
  ) %>%
  dplyr::mutate(X = x, Y = y)


bio5perc <- sum(gf3$mean_biomass, na.rm = TRUE) * 0.05
s <- sort(gf3$mean_biomass)

bio_sum <- cumsum(s)
lower_density_threshold <- s[which(bio_sum >= bio5perc)[1]]

gf3t <- filter(gf3, mean_biomass > lower_density_threshold)
```

```{r eval=T}
gf3t$squashed_velocity <- collapse_outliers(gf3t$velocity, c(0.005, 0.995))

grad3 <- gfranges::plot_vocc(gf3t,
  # theme = "black",
  coast = TRUE,
  vec_aes = NULL,
  # grad_vec_aes = "velocity",
  # vec_lwd_range = c(0.5, 0.5),
  NA_label = "NA",
  fill_col = "squashed_velocity",
  fill_label = "biotic \nvelocity",
  raster_alpha = 1,
  # raster_limits = c(raster_min, raster_max),
  na_colour = "black",
  # white_zero = TRUE,
  high_fill = "Steel Blue 4",
  low_fill = "Red 3",
  axis_lables = FALSE,
  transform_col = sqrt # no_trans #
) + labs(
  title = paste0(species, " (", age, ")"), #
  subtitle = paste0("Biotic velocity ", min(d$year), "-", max(d$year))
)
grad3
```



```{r eval=T}
#raster_max <- quantile(gf3$mean_biomass, 0.995, na.rm = T)
gf3$mean_biomass2 <- collapse_outliers(gf3$mean_biomass, c(0, 0.995))
grad4 <- gfranges::plot_vocc(gf3,
  # theme = "black",
  coast = TRUE,
  vec_aes = NULL,
  # grad_vec_aes = "velocity",
  # vec_lwd_range = c(0.5, 0.5),
  NA_label = "NA",
  fill_col = "mean_biomass2",
  fill_label = "mean",
  raster_alpha = 1,
 # raster_limits = c(0, raster_max),
  na_colour = "white",
  # white_zero = TRUE,
  high_fill = "Steel Blue 4",
  low_fill = "Red 3",
  axis_lables = FALSE,
  transform_col = sqrt #
) + labs(
  title = paste0(species, " (", age, ")"), #
  subtitle = paste0("Mean biomass ", min(d$year), "-", max(d$year))
)
grad4
```

```{r eval=T}
grad5 <- gfranges::plot_vocc(gf3t,
  # theme = "black",
  coast = TRUE,
  vec_aes = NULL,
  # grad_vec_aes = "velocity",
  # vec_lwd_range = c(0.5, 0.5),
  NA_label = "NA",
  fill_col = "trend",
  fill_label = "biomass \ntrend",
  raster_alpha = 1,
  # raster_limits = c(0, 10),
  na_colour = "black",
  white_zero = TRUE,
  high_fill = "Steel Blue 4",
  low_fill = "Red 3",
  axis_lables = FALSE,
  transform_col = sqrt #
) + labs(
  title = paste0(species, " (", age, ")"), #
  subtitle = paste0("Biomass trend ", min(d$year), "-", max(d$year))
)
grad5
```

```{r eval=T}
grad6 <- gfranges::plot_vocc(gf3t,
  # theme = "black",
  coast = TRUE,
  vec_aes = NULL,
  # grad_vec_aes = "velocity",
  # vec_lwd_range = c(0.5, 0.5),
  NA_label = "NA",
  fill_col = "cv",
  fill_label = "sd in log space",
  raster_alpha = 1,
  # raster_limits = c(0, 7),
  na_colour = "black",
  # white_zero = TRUE,
  high_fill = "Steel Blue 4",
  low_fill = "Red 3",
  axis_lables = FALSE,
  transform_col = sqrt #
) + labs(
  title = paste0(species, " (", age, ")"), #
  subtitle = paste0("Biotic variability (cv from vocc_gradient_calc funcition) ", min(d$year), "-", max(d$year))
)
grad6
```

```{r eval=F}
raster_max <- quantile(gf3t$CV, 0.90, na.rm = TRUE)
grad7 <- gfranges::plot_vocc(gf3t,
  # theme = "black",
  coast = TRUE,
  vec_aes = NULL,
  # grad_vec_aes = "velocity",
  # vec_lwd_range = c(0.5, 0.5),
  NA_label = "NA",
  fill_col = "CV",
  fill_label = "CV",
  raster_alpha = 1,
  raster_limits = c(0, raster_max),
  na_colour = "black",
  # white_zero = TRUE,
  high_fill = "Steel Blue 4",
  low_fill = "Red 3",
  axis_lables = FALSE,
  transform_col = sqrt #
) + labs(
  title = paste0(species, " (", age, ")"), #
  subtitle = paste0("CV in estimated biomass ", min(d$year), "-", max(d$year))
)
grad7
```


### Save gradient-based VOCCs
```{r}

biotic_values <- gf3 %>%
  rename(
    biotic_vel = velocity,
    biotic_trend = trend,
    biotic_CV = CV,
    sd_est = cv,
    biotic_grad = gradient
  ) %>%
  mutate(
    sd_biomass = sd * 10000,
    mean_biomass = exp(mean) * 10000
  ) %>%
  select(x, y, biotic_vel, biotic_trend, biotic_grad, biotic_CV, sd_est, sd_biomass, mean_biomass) %>%
  mutate(start_year = !!start_year)


fished <- gf %>%
  select(x, y, fishing_trend, mean_effort)

DO_values <- gf0 %>%
  rename(
    DO_vel = velocity,
    DO_trend = trend_per_year,
    DO_grad = gradient,
    mean_DO = mean
  ) %>%
  select(x, y, DO_vel, DO_trend, DO_grad, mean_DO)

temp_values <- gf2 %>%
  rename(
    temp_vel = velocity,
    temp_trend = trend_per_year,
    temp_grad = gradient,
    mean_temp = mean
  ) %>%
  select(x, y, temp_vel, temp_trend, temp_grad, mean_temp)

vocc <- left_join(biotic_values, fished) # add fishing effort
vocc <- left_join(vocc, DO_values) # add DO
vocc <- left_join(vocc, temp_values) # add temp
vocc <- mutate(vocc, species = !!species, method = "gradient")

write.csv(vocc, file = paste0(
  "data/_do_new_grad/", age, "-w-do-nulls-", spp, "-", ssid_string, "-", covs, "-", min(d$year), "-", max(d$year), ".csv"
))
```

```{r eval=T}
vocc_t <- filter(vocc, mean_biomass > lower_density_threshold)
vocc_t$squashed_temp <- collapse_outliers(vocc_t$temp_vel, c(0.005, 0.995))

grad2t <- plot_vocc(vocc_t,
  # theme = "black",
  coast = TRUE,
  vec_aes = NULL,
  # grad_vec_aes = "velocity",
  # vec_lwd_range = c(0.5, 0.5),
  NA_label = "NA",
  fill_col = "squashed_temp",
  fill_label = "temperature \nvelocity",
  raster_alpha = 1,
  # raster_limits = c(raster_min, raster_max),
  na_colour = "white",
  white_zero = TRUE,
  vec_alpha = 0.35,
  axis_lables = FALSE,
  transform_col = sqrt #
) + labs(
  title = "temp velocity",
  subtitle = paste0(min(d$year), "-", max(d$year))
)

grad2t
```

```{r eval=T}
grad2tt <- plot_vocc(vocc_t,
  # theme = "black",
  coast = TRUE,
  vec_aes = NULL,
  # grad_vec_aes = "velocity",
  # vec_lwd_range = c(0.5, 0.5),
  NA_label = "NA",
  fill_col = "temp_trend",
  fill_label = "temperature \ntrend",
  raster_alpha = 1,
  # raster_limits = c(raster_min, raster_max),
  na_colour = "white",
  white_zero = TRUE,
  vec_alpha = 0.35,
  axis_lables = FALSE,
  transform_col = no_trans # log10 # fourth_root_power # sqrt #
) + labs(
  title = "temp trend",
  subtitle = paste0(min(d$year), "-", max(d$year))
)

grad2tt
```

```{r eval=T}
vocc_t$squashed_do <- collapse_outliers(vocc_t$DO_vel, c(0.005, 0.995))

# grad2dv <- 
plot_vocc(vocc_t,
  # theme = "black",
  coast = TRUE,
  vec_aes = NULL,
  # grad_vec_aes = "velocity",
  # vec_lwd_range = c(0.5, 0.5),
  NA_label = "NA",
  fill_col = "squashed_do",
  fill_label = "temperature \nvelocity",
  raster_alpha = 1,
  # raster_limits = c(raster_min, raster_max),
  na_colour = "white",
  white_zero = TRUE,
  vec_alpha = 0.35,
  axis_lables = FALSE,
  transform_col = sqrt #
) + labs(
  title = "DO velocity",
  subtitle = paste0(min(d$year), "-", max(d$year))
)

# grad2dv
```

```{r eval=T}
# grad2dt <- 
plot_vocc(vocc_t,
  # theme = "black",
  coast = TRUE,
  vec_aes = NULL,
  # grad_vec_aes = "velocity",
  # vec_lwd_range = c(0.5, 0.5),
  NA_label = "NA",
  fill_col = "DO_trend",
  fill_label = "DO \ntrend",
  raster_alpha = 1,
  # raster_limits = c(raster_min, raster_max),
  na_colour = "white",
  white_zero = TRUE,
  vec_alpha = 0.35,
  axis_lables = FALSE,
  transform_col = no_trans # log10 # fourth_root_power # sqrt #
) + labs(
  title = "DO trend",
  subtitle = paste0(min(d$year), "-", max(d$year))
)
# 
# grad2dt
```

```{r eval=T}
vocc_t$squashed_effort <- collapse_outliers(vocc_t$mean_effort, c(0.005, 0.995))

plot_vocc(vocc_t,
  # theme_black = TRUE,
  coast = TRUE,
  vec_aes = NULL,
  # grad_vec_aes = "velocity",
  # vec_lwd_range = c(0.5, 0.5),
  # NA_label = "NA",
  fill_col = "squashed_effort",
  fill_label = "mean effort",
  raster_alpha = 1,
  # raster_limits = c(raster_min, raster_max),
  na_colour = "white",
  # high_fill = "Steel Blue 4",
  # low_fill = "Red 3",
  # white_zero = TRUE,
  vec_alpha = 0.35,
  axis_lables = FALSE,
  transform_col = fourth_root_power #
) + labs(
  title = "Fishing presssure",
  subtitle = paste0(min(d$year), "-", max(d$year))
)


plot_vocc(vocc_t,
  # theme_black = TRUE,
  coast = TRUE,
  vec_aes = NULL,
  # grad_vec_aes = "velocity",
  # vec_lwd_range = c(0.5, 0.5),
  # NA_label = "NA",
  fill_col = "fishing_trend",
  fill_label = "trend",
  raster_alpha = 1,
  # raster_limits = c(raster_min, raster_max),
  # high_fill = "Steel Blue 4",
  # low_fill = "Red 3",
  # white_zero = TRUE,
  vec_alpha = 0.35,
  axis_lables = FALSE,
  transform_col = sqrt # no_trans #
) + labs(
  title = "Fishing trend",
  subtitle = paste0(min(d$year), "-", max(d$year))
)


```

