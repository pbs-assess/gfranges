---
title: "Sole Example from Wang et al. 2018"
output: html_notebook
---
```{r install, eval=FALSE}
library(devtools)
install.packages("INLA", repos=c(getOption("repos"), INLA="https://inla.r-inla-download.org/R/stable"), dep=TRUE)
install_github("julianfaraway/brinla")
install.packages('gamair')
```

# Sole eggs in the Bristol Channel
## Selected code from Wang et al. 2018 example

sole eggs per square meter of sea surface in each of 4 identifiable egg developmental stages, at each of a number of sampling stations in the Bristol Channel on the west coast of England. The samples were taken from 5 research cruises over the spawning season.
Let’s load the dataset and look at its structure:

```{r setup}
library(INLA)
library(brinla)
library(gamair)
data(sole, package = 'gamair')
```

```{r}
str(sole)
# sole$stage
```


la and lo are the latitude and longitude of sampling station,
t is the time of midpoint of the cruise on which this sample was taken, 
eggs is the egg density per square meter of sea surface, 
stage is one of 4 stages the sample relates, 
a.0 is the age of the youngest possible egg in this sample, and a.1 is of the oldest.
Following Wood (2006), we calculate the width (off) and average age (a) of the corresponding egg class:

```{r}
solr <- sole
solr$off <- log(sole$a.1 - sole$a.0)
solr$a <- (sole$a.1 + sole$a.0)/2

boxplot(a ~ stage, data = solr)
points(a.0 ~ stage, col = "red", data = solr)
points(a.1 ~ stage, col = "red", data = solr)
```


```{r}
solr$t <- solr$t - mean(sole$t)
solr$t <- solr$t/var(sole$t)^0.5
solr$la <- solr$la - mean(sole$la)
solr$lo <- solr$lo - mean(sole$lo)

hist(solr$eggs, breaks = 30)
boxplot(eggs ~ t, data = solr)
boxplot(eggs ~ stage, data = solr)
```

at each station counts for the four different egg stages are all taken from the same net sample

```{r}
solr$station <- as.numeric(factor(with(solr, paste(-la, -lo, -t, sep=""))))
```

```{r}
solr$eggs <- solr$eggs*1000
solr$off <- solr$off + log(1000)
```

```{r}
length(which(solr$eggs == 0))/length(solr$eggs)
```

 zero-inflated negative binomial (ZINB) likelihood

eggsi ∼ ZINB(ρ,n,pi), μi =n(1−pi)/pi

log(μi) = log(offi) + β0 + ai + lai∗ti + lai∗t2i + loi∗ti + loi∗t2i + ai*f1(ti)+ f2(loi,lai) + stationj(i)

(9.8) 

where ρ is the zero-probability parameter, n is the overdispersion parameter, pi is the
probability of “success” in ith trial, and μi is the mean of ith egg density.

```{r}
loc <- cbind(solr$lo, solr$la)
mesh <- inla.mesh.2d(loc, max.edge = c(0.1, 0.2))
node <- mesh$idx$loc
tps <- bri.tps.prior(mesh, constr = TRUE)
```


```{r}
formula1 <- eggs ~ a + I(la*t) + I(la*t^2) + I(lo*t) + I(lo*t^2) + f(t, a, model = 'rw2', scale.model = TRUE) + f(node, model = tps, diagonal = 1e-6) + f(station, model = 'iid')
```

```{r}
result1 <- inla(formula1, 
                family = 'zeroinflatednbinomial0', 
                offset = off, 
                data = solr, 
                control.predictor = list(compute = TRUE), 
                control.compute = list(dic = TRUE, waic = TRUE, cpo = TRUE))

```

```{r}
result1 <- result1
round(result1$summary.fixed, 4)
```

```{r}
bri.band.ggplot(result1, name = 't', type = 'random')
```

```{r}
bri.fixed.plot(result1)
```

```{r}
plot(result1, single = FALSE)
```
  
```{r, warning=FALSE}
proj <- inla.mesh.projector(mesh)
spa.mean <- inla.mesh.project(proj, result1$summary.random$node$mean)
library(fields)
image.plot(proj$x, proj$y, spa.mean, xlim=c(-1.5, 2), ylim=c(-1, 1))
points(loc, pch = 19, cex = 0.2)
```
  
The posterior distributions of the hyperparameters are summarized using:
 
```{r}
tmp <- bri.hyperpar.summary(result1)
row.names(tmp) <- c("Overdispersion", "Zero-probability", 'SD for t',
'Theta1 for node', 'SD for station') 
round(tmp, 4)
```

```{r}
length(which(result1$cpo$failure > 0))
```



# My modifications:

## What about getting effect of a to change through time?

```{r}
solr$t.age <- solr$t # duplicates t for the a slope change through time

formula.t.a <- eggs ~ I(a) + I(a^2) + I(la*t) + I(la*t^2) + I(lo*t) + I(lo*t^2) + f(t, model = 'rw2', scale.model = TRUE) + f(t.age, a, model = 'rw2', scale.model = TRUE) + f(node, model = tps, diagonal = 1e-6) + f(station, model = 'iid')

# without quadratic fixed effect of age
formula.t.a.nq <- eggs ~ I(a) + I(la*t) + I(la*t^2) + I(lo*t) + I(lo*t^2) + f(t, model = 'rw2', scale.model = TRUE) + f(t.age, a, model = 'rw2', scale.model = TRUE) + f(node, model = tps, diagonal = 1e-6) + f(station, model = 'iid')

# without age varying with time
formula.t <- eggs ~ I(a) + I(a^2) + I(la*t) + I(la*t^2) + I(lo*t) + I(lo*t^2) + f(t, model = 'rw2', scale.model = TRUE) + f(node, model = tps, diagonal = 1e-6) + f(station, model = 'iid')
```

```{r}
result.t.a <- inla(formula.t.a, 
                family = 'zeroinflatednbinomial0', 
                offset = off, 
                data = solr, 
                control.predictor = list(compute = TRUE), 
                control.compute = list(dic = TRUE, waic = TRUE, cpo = TRUE, config=TRUE))
```

```{r}
result.t.a.nq <- inla(formula.t.a.nq, 
                family = 'zeroinflatednbinomial0', 
                offset = off, 
                data = solr, 
                control.predictor = list(compute = TRUE), 
                control.compute = list(dic = TRUE, waic = TRUE, cpo = TRUE, config=TRUE))
```

```{r}
result.t <- inla(formula.t, 
                family = 'zeroinflatednbinomial0', 
                offset = off, 
                data = solr, 
                control.predictor = list(compute = TRUE), 
                control.compute = list(dic = TRUE, waic = TRUE, cpo = TRUE, config=TRUE))
```

```{r}
c(result.t.a$dic$dic, result.t.a.nq$dic$dic, result.t$dic$dic, result1$dic$dic)
```

```{r}
result <- result.t.a.nq
round(result$summary.fixed, 4)
#round(result$summary.fixed[, c("mean", "0.025quant", "0.975quant")], 4)
```

```{r}
summary(result)$hyperpar[, c("mean", "0.025quant", "0.975quant")]
```

```{r}
bri.band.ggplot(result, name = 't', type = 'random')
```

```{r}
?bri.band.ggplot
bri.band.ggplot(result, name = 't.age', type = 'random')
```

```{r}
bri.fixed.plot(result)
```

```{r, warning=FALSE}
proj <- inla.mesh.projector(mesh)
spa.mean <- inla.mesh.project(proj, result$summary.random$node$mean)
library(fields)
image.plot(proj$x, proj$y, spa.mean, xlim=c(-1.5, 2), ylim=c(-1, 1))
points(loc, pch = 19, cex = 0.2)
```

```{r}
result$cpo$cpo  
result$cpo$failure
```

