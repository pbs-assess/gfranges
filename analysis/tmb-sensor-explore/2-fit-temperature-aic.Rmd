# Fit spatial temporal models to bottom temperature

```{r setup}
library(tidyverse)
library(sdmTMB)

d_trawl <- readRDS(here::here("analysis/tmb-sensor-explore/sensor-data-processed.rds"))

set.seed(39201114) # original seed, predictions max out at .88 cor with true temp
#set.seed(392011149)
d_trawl$log_temperature_c <- log(d_trawl$temperature_c)
```

```{r}
withheld_fe <- sample(d_trawl$fishing_event_id, size = round(nrow(d_trawl)*.2))

d_withheld <- filter(d_trawl, fishing_event_id %in% withheld_fe)

d_fit <- filter(d_trawl, !fishing_event_id %in% withheld_fe)

nrow(d_fit) # 3774
nrow(d_withheld) # 943
unique(d_withheld$year) 
unique(d_fit$year)
length(unique(d_fit$year))

# FIXME: need to work out a bug in production on this new data set
# It's crashing TMB.

#d_fit <- d_trawl
#d_withheld <- d_trawl
```

```{r}
spde <- make_spde(d_fit$X, d_fit$Y, n_knots = 250)
plot_spde(spde)
```

Functions for model exploration:
```{r}
plot_map <- function(dat, column = "est") {
  ggplot(dat, aes_string("X", "Y", colour = column)) +
    geom_point() +
    facet_wrap(~year) +
    coord_fixed()
}

aic <- function(m) {
  k <- length(m$model$par)
  nll <- m$model$objective
  2 * k - 2 * (-nll)
}
```


Various candidate models:

```{r}
m_temp1 <- sdmTMB(d_fit, temperature_c ~ 0 + as.factor(year) + depth_scaled,
  time = "year", spde = spde, family = gaussian(link = "identity"), 
  ar1_fields = FALSE, include_spatial = TRUE, #these are defaults
  anisotropy = FALSE, 
  silent = TRUE)

predictions <- predict(m_temp1)
predictions$data$residuals <- residuals(m_temp1)
cor(predictions$data$est, predictions$data$temperature_c)^2
aic(m_temp1)
```

AR1 fields slightly improves linear model AIC, but not R^2
```{r}
m_temp1_ar1 <- sdmTMB(d_fit, temperature_c ~ 0 + as.factor(year) + depth_scaled,
  time = "year", spde = spde, family = gaussian(link = "identity"), 
  ar1_fields = TRUE, include_spatial = TRUE, 
  anisotropy = FALSE, 
  silent = TRUE)

predictions_ar1 <- predict(m_temp1_ar1)
predictions_ar1$data$residuals <- residuals(m_temp1_ar1)
cor(predictions_ar1$data$est, predictions_ar1$data$temperature_c)^2
aic(m_temp1_ar1)
```

Time-varying slope for depth effect makes huge improvement in AIC, but none for R^2
```{r}
m_temp1_rw <- sdmTMB(d_fit, temperature_c ~ 0 + as.factor(year),   
  time_varying = ~ 0 + depth_scaled,
  ar1_fields = FALSE, include_spatial = TRUE, #these are defaults
  time = "year", spde = spde, family = gaussian(link = "identity"),
  silent = TRUE)

predictions1_rw <- predict(m_temp1_rw)
predictions1_rw$data$residuals <- residuals(m_temp1_rw)
cor(predictions1_rw$data$est, predictions1_rw$data$temperature_c)^2
aic(m_temp1_rw)
```

AR1 field in addition to time-varying slope does NOT improve AIC
```{r}
m_temp1_rw_ar1 <- sdmTMB(d_fit, temperature_c ~ 0 + as.factor(year),   
  time_varying = ~ 0 + depth_scaled,
  ar1_fields = TRUE, include_spatial = TRUE,
  time = "year", spde = spde, family = gaussian(link = "identity"),
  silent = TRUE)

predictions1_rw_ar1 <- predict(m_temp1_rw_ar1)
predictions1_rw_ar1$data$residuals <- residuals(m_temp1_rw_ar1)
cor(predictions1_rw_ar1$data$est, predictions1_rw_ar1$data$temperature_c)^2
aic(m_temp1_rw_ar1)
```

Time-varying has much better AIC than spatial trend varying
```{r}
m_temp1_st <- sdmTMB(d_fit,
  temperature_c ~ 0 + as.factor(year) + depth_scaled,
  #time_varying =  ~ 0 + depth_scaled,
  include_spatial = TRUE, ar1_fields = FALSE, spatial_trend = TRUE, 
  # seems to be only config that converges
  time = "year", spde = spde, family = gaussian(link = "identity"),
  silent = TRUE)

predictions1_st <- predict(m_temp1_st)
predictions1_st$data$residuals <- residuals(m_temp1_st)
cor(predictions1_st$data$est, predictions1_st$data$temperature_c)^2 # 
aic(m_temp1_st)
```

Both time and space varying... doesn't improve any indices
```{r}
m_temp1_rw_st <- sdmTMB(d_fit,
  temperature_c ~ 0 + as.factor(year), 
  time_varying =  ~ 0 + depth_scaled,
  include_spatial = TRUE, ar1_fields = FALSE, spatial_trend = TRUE, 
  time = "year", spde = spde, family = gaussian(link = "identity"),
  silent = TRUE)

predictions1_rw_st <- predict(m_temp1_rw_st)
predictions1_rw_st$data$residuals <- residuals(m_temp1_rw_st)
cor(predictions1_rw_st$data$est, predictions1_rw_st$data$temperature_c)^2 # 
aic(m_temp1_rw_st)
```

What about polynomial response to depth?

Ignore simplest configurations because both time-varying, and a fixed spatial field, seem critically important.

```{r, eval=FALSE}
m_temp2 <- sdmTMB(d_fit, 
  temperature_c ~ 0 + as.factor(year) + poly(depth_scaled, 2),
  ar1_fields = FALSE, include_spatial = TRUE, #these are defaults
  time = "year", spde = spde, family = gaussian(link = "identity"),
  silent = TRUE)

predictions2 <- predict(m_temp2)
predictions2$data$residuals <- residuals(m_temp2)
cor(predictions2$data$est, predictions2$data$temperature_c)^2
aic(m_temp2)
```

```{r, eval=FALSE}
m_temp2_nosp <- sdmTMB(d_fit, 
  temperature_c ~ 0 + as.factor(year) + poly(depth_scaled, 2),
  ar1_fields = FALSE, include_spatial = FALSE, 
  time = "year", spde = spde, family = gaussian(link = "identity"),
  silent = TRUE)

predictions2_nosp <- predict(m_temp2_nosp)
predictions2_nosp$data$residuals <- residuals(m_temp2_nosp)
cor(predictions2_nosp$data$est, predictions2_nosp$data$temperature_c)^2
aic(m_temp2_nosp)
```


```{r}
m_temp2_rw <- sdmTMB(d_fit, temperature_c ~ 0 + as.factor(year),   
  time_varying = ~ 0 + poly(depth_scaled, 2),
  ar1_fields = FALSE, include_spatial = TRUE, #these are defaults
  time = "year", spde = spde, family = gaussian(link = "identity"),
  silent = TRUE)

predictions2_rw <- predict(m_temp2_rw)
predictions2_rw$data$residuals <- residuals(m_temp2_rw)
cor(predictions2_rw$data$est, predictions2_rw$data$temperature_c)^2
aic(m_temp2_rw)
```

```{r, eval=FALSE}
m_temp2_rw_nosp <- sdmTMB(d_fit,
  temperature_c ~ 0 + as.factor(year),
  time_varying =  ~ 0 + poly(depth_scaled, 2),
  include_spatial = FALSE, ar1_fields = FALSE,
  time = "year", spde = spde, family = gaussian(link = "identity"),
  silent = TRUE)

predictions2_rw_nosp <- predict(m_temp2_rw_nosp)
predictions2_rw_nosp$data$residuals <- residuals(m_temp2_rw_nosp)
cor(predictions2_rw_nosp$data$est, predictions2_rw_nosp$data$temperature_c)^2
aic(m_temp2_rw_nosp)
```

```{r, eval=FALSE}
m_temp2_st <- sdmTMB(d_fit,
  temperature_c ~ 0 + as.factor(year),
  time_varying =  ~ 0 + poly(depth_scaled, 2),
  include_spatial = TRUE, ar1_fields = FALSE, spatial_trend = TRUE, 
  # seems to be only config that converges
  time = "year", spde = spde, family = gaussian(link = "identity"),
  silent = TRUE)

predictions2_st <- predict(m_temp2_st)
predictions2_st$data$residuals <- residuals(m_temp2_st)
cor(predictions2_st$data$est, predictions2_st$data$temperature_c)^2 # 
aic(m_temp2_st)
```

What about 3 order polynomial?
```{r, eval=FALSE}
m_temp3 <- sdmTMB(d_fit, 
  temperature_c ~ 0 + as.factor(year) + poly(depth_scaled, 3),
  ar1_fields = FALSE, include_spatial = TRUE, #these are defaults
  time = "year", spde = spde, family = gaussian(link = "identity"),
  silent = TRUE)

predictions3 <- predict(m_temp3)
predictions3$data$residuals <- residuals(m_temp3)

cor(predictions3$data$est, predictions3$data$temperature_c)^2 # 
```


```{r}
m_temp3_rw <- sdmTMB(d_fit,
  temperature_c ~ 0 + as.factor(year),
  time_varying =  ~ 0 + poly(depth_scaled, 3),
  ar1_fields = FALSE, include_spatial = TRUE, 
  time = "year", spde = spde, family = gaussian(link = "identity"),
  silent = TRUE)

predictions3_rw <- predict(m_temp3_rw)
predictions3_rw$data$residuals <- residuals(m_temp3_rw)
cor(predictions3_rw$data$est, predictions3_rw$data$temperature_c)^2 # 
aic(m_temp3_rw)
```

```{r, eval = FALSE}
m_temp3_rw_nosp <- sdmTMB(d_fit,
  temperature_c ~ 0 + as.factor(year),
  time_varying =  ~ 0 + poly(depth_scaled, 3),
  include_spatial = FALSE, ar1_fields = FALSE,
  time = "year", spde = spde, family = gaussian(link = "identity"),
  silent = TRUE)

predictions3_rw_nosp <- predict(m_temp3_rw_nosp)
predictions3_rw_nosp$data$residuals <- residuals(m_temp3_rw_nosp)
cor(predictions3_rw_nosp$data$est, predictions3_rw_nosp$data$temperature_c)^2 # 
```


# Conclusion: log depth, both 2nd and 3rd order polynomials, that is time-varying

```{r}
ggplot(predictions2_rw$data, aes(temperature_c, est)) +
  geom_point() +
  facet_wrap(~year) +
  coord_fixed() +
  geom_abline()
```


Residual plots:
```{r}
ggplot(predictions2_rw$data, aes(est, residuals)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~year)
```

```{r}
ggplot(predictions3_rw$data, aes(est, residuals)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~year)
```

```{r}
ggplot(predictions2_rw$data, aes(depth_scaled, residuals)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~year)
```

```{r}
ggplot(predictions3_rw$data, aes(depth_scaled, residuals)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~year)
```

```{r}
ggplot(predictions2_rw$data, aes(depth_scaled, residuals)) +
  geom_point() +
  geom_smooth()
```

```{r}
ggplot(predictions3_rw$data, aes(depth_scaled, residuals)) +
  geom_point() +
  geom_smooth()
```




# R2

```{r}
cor(predictions2_rw$data$est, predictions2_rw$data$temperature_c)^2
```

# Extrapolate:

#FIXME: this is crashing R
```{r}
# predictions_nd <- predict(m_temp3_rw, newdata = sdmTMB::qcs_grid)
#saveRDS(predictions3_rw_nd$data, file = "qcs-temp.rds")
```


# A short function for plotting our predictions:

```{r}
plot_map <- function(dat, column = "est") {
  ggplot(dat, aes_string("X", "Y", fill = column)) +
    geom_raster() +
    facet_wrap(~year) +
    coord_fixed()
}
```

```{r}
plot_map(predictions_nd$data, "est") +
  scale_fill_viridis_c(trans = "sqrt", option = "C") +
  ggtitle("Prediction (fixed effects + all random effects)")
```

```{r}
plot_map(predictions_nd$data, "est_fe") +
  ggtitle("Prediction (fixed effects only)") +
  scale_fill_viridis_c(trans = "sqrt")
```

```{r}
plot_map(predictions_nd$data, "est_re_s") +
  ggtitle("Spatial random effects only") +
  scale_fill_gradient2()
```

```{r}
plot_map(predictions_nd$data, "est_re_st") +
  ggtitle("Spatiotemporal random effects only") +
  scale_fill_gradient2()
```

```{r}
# m_temp2_rw$model$par
# 2 * plogis(m_temp1$model$par[["ar1_phi"]]) - 1
# exp(m_temp2_rw$model$par[["ln_phi"]])

p_withheld2_rw <- predict(m_temp2_rw, newdata = d_withheld)
cor(p_withheld2_rw$data$est, p_withheld2_rw$data$temperature_c)^2 # 0.87 in first 
```


```{r}
ggplot(p_withheld2_rw$data, aes(temperature_c,est)) +
  geom_point() +
  facet_wrap(~year) +
  coord_fixed() +
  xlim(3,15) +
  ylim(3,15) +
  geom_abline()
```

```{r}
# m_temp3_rw$model$par
# 2 * plogis(m_temp1$model$par[["ar1_phi"]]) - 1
# exp(m_temp3_rw$model$par[["ln_phi"]])

p_withheld3_rw <- predict(m_temp3_rw, newdata = d_withheld)

#FIXME: p_withheld$data$temperature_c is all zeros?!?!?! 
# temp work around (first make sure both df in same order)
# arrange(p_withheld3_rw$data, fishing_event_id) 
# arrange(d_withheld, fishing_event_id) 
# p_withheld3_rw$data$temperature_c <- d_withheld$temperature_c

cor(p_withheld3_rw$data$est, p_withheld3_rw$data$temperature_c)^2 # 0.87
```

```{r}
ggplot(p_withheld2_rw$data, aes(temperature_c,est)) +
  geom_point() +
  facet_wrap(~year) +
  coord_fixed() +
  xlim(3,15) +
  ylim(3,15) +
  geom_abline()
```





```{r}
plot_map(predictions2_rw$data, "est") +
  scale_colour_viridis_c() +
  ggtitle("Prediction (fixed effects + all random effects)")
```


```{r}
plot_map(predictions$data, "est_re_s") +
  ggtitle("Spatial random effects only") +
  scale_colour_gradient2()
```

```{r}
plot_map(predictions$data, "est_re_st") +
  ggtitle("Spatiotemporal random effects only") +
  scale_colour_gradient2()
```






```{r}
temp_cog <- get_cog(predictions_nd)

temp_cog %>% reshape2::dcast(year ~ coord, value.var = "est") %>%
  ggplot(aes(X, Y, colour = year)) + geom_path(arrow = arrow()) +
  scale_color_viridis_c()
```

```{r}
temp_cog %>%
  ggplot(aes(year, est, ymin = lwr, ymax = upr)) +
  geom_line() +
  geom_ribbon(alpha = 0.2) +
  facet_wrap(~coord, scales = "free_y")
```