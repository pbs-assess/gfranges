---
output: html_document
editor_options: 
  chunk_output_type: inline
---
# Fit spatial temporal models of bottom DO

```{r setup}
library(tidyverse)
library(gfplot)
library(sdmTMB)
library(gfranges)
```

Load data
```{r}
all_sensor <- readRDS(here::here("analysis/tmb-sensor-explore/data/all-sensor-data-processed.rds"))
# glimpse(all_sensor)

d_trawl <- all_sensor %>%
  # filter missing do data 
  dplyr::filter(!is.na(do_mlpl)) %>%
  # remove 2007 data because clearly faulty or scaled differently
  dplyr::filter(year>2007) %>%
  # add day of year variable
  mutate(DOY = lubridate::yday(fe_event_start), temp = temperature_c, 
    raw_depth = depth, depth = log(depth), log_do = log(do_mlpl)) %>%
  # scale potential covariates across all surveys
  scale_predictors(predictors = c(quo(depth), quo(DOY), quo(temp)))

d_trawl <- d_trawl[!is.na(d_trawl$depth), ]
d_trawl <- d_trawl[!is.na(d_trawl$temperature_c), ]

d_trawl <- d_trawl %>% mutate(exclude = if_else(do_mlpl>8, 1, 0)) %>% 
  filter(exclude != 1)

# glimpse(d_trawl)
```

Ranges sampled
```{r}
paste("depth") 
range(d_trawl$raw_depth)
paste("DO") 
range(d_trawl$do_mlpl)
```

Model diagnostics functions
```{r}
get_diag <- function(m, response = "log_do", variable = "depth_scaled") {
  predictions <- predict(m)
  predictions$residuals <- residuals(m)
  
  plot_map <- function(dat, column = "est") {
    ggplot(dat, aes_string("X", "Y", colour = column)) +
      geom_point() +
      coord_fixed()
  }
  
  g <- plot_map(predictions, "est") +
    scale_colour_viridis_c() +
    ggtitle("Prediction (fixed effects + all random effects)")
  print(g)
  
  g <- plot_map(predictions, "est_non_rf") +
    ggtitle("Prediction (fixed effects only)") +
    scale_colour_viridis_c()
  print(g)
  
  g <- plot_map(predictions, "est_rf") +
    ggtitle("All random effects only") +
    scale_colour_gradient2()
  print(g)
   
  g <- plot_map(predictions, "omega_s") +
    ggtitle("Spatial random effects only") +
    scale_colour_gradient2()
 print(g)
   
   g <- plot_map(predictions, "epsilon_st") +
    ggtitle("Spatiotemporal random effects only") +
    facet_wrap(~year) +
    scale_colour_gradient2()
 print(g)
 
  g <- ggplot(predictions, aes_string("est", response)) +
    geom_point() +
    facet_wrap(~year) +
    coord_fixed() +
    geom_abline()
  print(g)
  
  g <- ggplot(predictions, aes(est, residuals)) +
    geom_point() +
    geom_smooth()
  print(g)
  
  g <- ggplot(predictions, aes_string(variable, "residuals")) +
    geom_point() +
    geom_smooth() +
    facet_wrap(~year)
  print(g)
  
  g <- ggplot(predictions, aes(X, Y, colour = residuals)) +
    geom_point() +
    coord_fixed() +
    scale_color_gradient2()+
    facet_wrap(~year)
  print(g)
  
  aic <- function(m) {
    k <- length(m$model$par)
    nll <- m$model$objective
    2 * k - 2 * (-nll)
  }

  print("R^2:")
  r2 <- cor(predictions$est, predictions[[response]])^2
  print(r2)
  
  print("")
  print("AIC:")
  print(aic(m))
}
```


```{r}
ggplot(d_trawl, aes(X,Y, colour = do_mlpl)) +
  geom_point() +
  facet_wrap(~year) +
  scale_color_viridis_c()
```

```{r}
ggplot(d_trawl, aes(X,Y, colour = temp)) +
  geom_point() +
  facet_wrap(~year) +
  scale_color_viridis_c()
```

```{r}
ggplot(d_trawl, aes(depth, do_mlpl, colour = DOY, size = sqrt(do_change))) +
  geom_point() +
  facet_wrap(~year) +
  scale_color_viridis_c()

```

```{r}
ggplot(d_trawl, aes(raw_depth, temp, colour = DOY, size = sqrt(temp_range))) +
  geom_point() +
  facet_wrap(~year) +
  scale_color_viridis_c()
```



```{r}
ggplot(d_trawl, aes(temp, log_do, colour = DOY, size = sqrt(temp_range))) +
  geom_point() +
  facet_wrap(~year) +
  scale_color_viridis_c()
```

```{r}
ggplot(d_trawl, aes(temp, do_mlpl, colour = as.factor(ssid))) +
  geom_point() +
  facet_wrap(~year) +
  scale_color_viridis_d()
```

```{r}
ggplot(filter(d_trawl, year==2016), aes(temp, do_mlpl, colour = as.factor(ssid))) +
  geom_point() +
  #facet_wrap(~year) +
  scale_color_viridis_d(begin=0.65)
```

```{r}
ggplot(filter(d_trawl, year==2017), aes(temp, do_mlpl, colour = as.factor(ssid))) +
  geom_point() +
  #facet_wrap(~year) +
  scale_color_viridis_d(end = 0.35)
```

```{r}
ggplot(d_trawl, aes(DOY, -depth , colour = do_mlpl)) + geom_point() + facet_wrap(~year) +
  scale_color_viridis_c() + ylab("-log(depth)")
```

```{r}
hist(d_trawl$do_mlpl)
# log do_mlpl to allow gaussian 
hist(d_trawl$log_do)
```


Remove WCVI in 2016 due to extreme values and make 500 knot mesh
```{r}
d_trawl1 <- d_trawl %>% filter(!(year == 2016 & ssid ==4)) 

spde <- make_spde(d_trawl1$X, d_trawl1$Y, n_knots = 500) 
plot_spde(spde)
```

Current best model of DO
```{r }
do_model_all_DOY <- sdmTMB::sdmTMB(
      log_do ~ 0 + as.factor(year) + temp_scaled + temp_scaled2 + DOY_scaled,
      data = d_trawl1,
      time_varying = ~ 0 + depth_scaled + depth_scaled2, 
      time = "year", 
      spde = spde,
      family = gaussian(link = "identity"),
      ar1_fields = TRUE,
      include_spatial = TRUE,
      enable_priors = FALSE,
      control = sdmTMBcontrol(step.min = 0.01, step.max = 1),
      silent = FALSE
    )

saveRDS(do_model_all_DOY, file = (here::here("analysis/tmb-sensor-explore/models/model-do-without-wcvi2016.rds")))
```


```{r eval=FALSE}
get_diag(do_model_all_DOY, response = "log_do", variable = "depth_scaled")
```


Predict DO for whole grid using quadratic of predicted temperature values and mean DOY
```{r eval=FALSE}
model1 <- readRDS(here::here("analysis/tmb-sensor-explore/models/model-temp-all-years-500kn.rds"))
model2 <- readRDS(here::here("analysis/tmb-sensor-explore/models/model-do-without-wcvi2016-depth2.rds"))

nd_all <- readRDS(here::here("analysis/VOCC/data/nd_all_synoptic.rds")) %>% filter(year<2019)

pred_temp <- predict(model1, newdata = nd_all)

# get scaling used in model
sensor_temp_scaled <- scale(d_trawl$temp)
attributes(sensor_temp_scaled)

predtemp <- pred_temp %>% mutate(
  temp_scaled = (est - attributes(sensor_temp_scaled)[[2]] )/attributes(sensor_temp_scaled)[[3]], 
  temp_scaled2 = (temp_scaled)^2) %>% select(-est, -est_non_rf, -est_rf, -omega_s, -zeta_s, -epsilon_st)
predtemp <- predtemp %>% filter(year > 2007) 
predtemp$DOY_scaled <- 0

# make DO predictions
pred_do <- predict(model2, newdata = predtemp)

# rename and back transform climate variables
pred_do$temp <- pred_do$temp_scaled * attributes(sensor_temp_scaled)[[3]] + attributes(sensor_temp_scaled)[[2]]
pred_do$log_do <- pred_do$est
pred_do$do_est <- exp(pred_do$log_do)

# may want to filter estimates for depths less than 15 m
# pred_do <- pred_do %>% filter(depth>15)

saveRDS(pred_do, file=here::here("analysis/VOCC/data/predicted-DO-depth2.rds"))
```


Plot predictions from saved DO predictions file
```{r}
p_nd <- readRDS((here::here("analysis/VOCC/data/predicted-DO-depth2.rds")))

plot_map_raster <- function(dat, column = "est") {
    ggplot(dat, aes_string("X", "Y", fill = column)) +
    geom_raster() +
    coord_fixed()+
gfplot::theme_pbs() + theme(axis.title.x = element_blank(), axis.title.y = element_blank())
}

plot_map_raster(p_nd, "do_est") +
  scale_fill_viridis_c(trans = "log") +
  facet_wrap(~year) +
  ggtitle("Prediction (fixed effects + all random effects)")
```

Plot each survey separately
```{r}
p_nd1 <- p_nd %>% filter(ssid!=16) %>% filter(ssid!=4)

breaks <- scales::trans_breaks(no_trans[["transform"]], no_trans[["inverse"]], n = 6)
labels <- function(x) format(x, digits = 2, scientific = FALSE)
 
pred_1 <- plot_map_raster(p_nd1, "do_est") +
  scale_fill_viridis_c(labels = labels, breaks = c(0,2,4,6,8), 
    limits = c(1, 8), 
    na.value = "red") +
  facet_wrap(~year) +
  labs(fill = "ml/L DO") +
  ggtitle("Prediction (fixed effects + all random effects)") + 
  theme(legend.position = c(.85,.25))
pred_1
```

```{r}
p_nd4 <- p_nd %>% filter(ssid==4) #%>% filter(year!=2016)
pred_4 <- plot_map_raster(p_nd4, "do_est") +
  scale_fill_viridis_c(labels = labels, breaks = c(0,2,4,6,8), limits = c(1, 7), 
     na.value = "red")+
  facet_wrap(~year) +
  labs(fill = "ml/L DO") +
  #ggtitle(" ")+ 
  theme(legend.position = "none")
pred_4
```

```{r}
plot_map_raster(p_nd, "est_non_rf") +
  ggtitle("Prediction (fixed effects only)") +
  facet_wrap(~year) +
  scale_fill_viridis_c()
```

```{r}
plot_map_raster(p_nd, "est_rf") +
  ggtitle("Prediction (all random effects only)") +
  facet_wrap(~year) +
  scale_fill_viridis_c()
```

```{r, eval=FALSE}
omega_s_all <- plot_map_raster(p_nd, "omega_s") +
  ggtitle("Spatial random effects only") +
   scale_fill_gradient2( high = "Steel Blue 4",
  low = "Red 3", limits = c(-0.65,1))+
  labs(fill = " ") + 
gfplot::theme_pbs() + theme(axis.title.x = element_blank(), axis.title.y = element_blank(), legend.position = c(.82,.75))

omega_s_all
```

```{r}
 plot_map_raster(p_nd, "epsilon_st") +
  ggtitle("Spatiotemporal random effects only") +
  facet_wrap(~year) +
  scale_fill_gradient2( high = "Steel Blue 4",
  low = "Red 3")
```

```{r}
p_nd1 <- p_nd %>% filter(ssid!=16) %>% filter(ssid!=4)
st_1n3 <- plot_map_raster(p_nd1, "epsilon_st") +
  ggtitle("Spatiotemporal random effects") +
  facet_wrap(~year) +
  scale_fill_gradient2( high = "Steel Blue 4",
  low = "Red 3", limits = c(-0.5,0.5)) +
        labs(fill = " ") + 
gfplot::theme_pbs() + theme(axis.title.x = element_blank(), axis.title.y = element_blank(), legend.position = c(.85,.25))
st_1n3
```

```{r}
p_nd4 <- p_nd %>% filter(ssid==4) #%>% filter(year!=2016)
st_4 <- plot_map_raster(p_nd4, "epsilon_st") +
  #ggtitle(" ") +
  facet_wrap(~year) +
  scale_fill_gradient2( high = "Steel Blue 4",
  low = "Red 3", limits = c(-0.5,0.5)) +
          labs(fill = "epsilon") + 
gfplot::theme_pbs() + theme(axis.title.x = element_blank(), axis.title.y = element_blank(), legend.position = "none")
st_4
```

```{r}
p_nd16 <- p_nd %>% filter(ssid==16) #%>% filter(ssid!=4)
st_16 <- plot_map_raster(p_nd16, "epsilon_st") +
  #ggtitle(" ") +
  facet_wrap(~year) +
  scale_fill_gradient2( high = "Steel Blue 4",
  low = "Red 3", limits = c(-0.5,0.5)) +
  xlim(65,345) +
    ylim(5800,6100) +
gfplot::theme_pbs() + theme(axis.title.x = element_blank(), axis.title.y = element_blank(), legend.position = "none")
st_16
```


```{r, eval= F}
png(
  file = "figs/do-predictions-without-wcvi2016.png", 
  res = 600,
  units = "in",
  width = 11, 
  height = 6.5
) 

gridExtra::grid.arrange(
  grobs = list(pred_1, st_1n3, omega_s_all, pred_4, st_4, st_16 ),
  widths = c(2, 2, 1.75),
  heights = c(2, 1.5),
  layout_matrix = rbind(c(1, 2, 3),
                        c(4, 5, 6)),
  top = grid::textGrob("Dissolved oxygen estimates from sdmTMB model")
)
dev.off()
```
