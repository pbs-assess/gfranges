# Fit spatial temporal models to bottom temperature

```{r setup}
library(tidyverse)
library(sdmTMB)
library(future)

d_trawl <- readRDS(here::here("analysis/tmb-sensor-explore/sensor-data-processed.rds"))
#set.seed(39201114) # original seed, predictions max out at .88 cor with true temp
set.seed(392011149)
#d_trawl$log_temperature_c <- log(d_trawl$temperature_c)
d_trawl$depth_scaled3 <- (d_trawl$depth_scaled)^3
```


### Functions for model exploration:
```{r}
generate_cv_args <- function(
                formula = formula,
                time_varying = time_varying,
                ar1_fields = c(FALSE,TRUE), 
                include_spatial = c(FALSE,TRUE),
                n_knots = c(30,80),
                seed = c(999)
  ){
  arguments <- expand.grid(
    formula = formula,
    time_varying = time_varying,
    include_spatial = include_spatial,
    ar1_fields = ar1_fields,
    n_knots = n_knots,
    seed = seed
  )
  args <- as_tibble(arguments)
  args
}

plot_cv_meshes <- function(cv_out) {
  k <- max(cv_out$data$cv_fold)
  op <- graphics::par(
      mfrow = c((sqrt(k)), ceiling(sqrt(k))),
      mar = c(1, 1, 1, 1)
    )
  for (i in seq_len(k)){
    plot_spde(cv_out$models[[i]]$spde)
  }
graphics::par(op)
}

aic <- function(m) {
  k <- length(m$model$par)
  nll <- m$model$objective
  2 * k - 2 * (-nll)
}
```


# 10-fold cross-validation 
#FIXME: need to extract information on whether or not models converge
## All fixed slope models
```{r}
cv_args <- generate_cv_args (formula = list(
    temperature_c ~ 0 + as.factor(year) + depth_scaled,
    temperature_c ~ 0 + as.factor(year) + depth_scaled + depth_scaled2,
    temperature_c ~ 0 + as.factor(year) + depth_scaled + depth_scaled2 + depth_scaled3),
    time_varying = list(NULL),
    ar1_fields = c(FALSE), 
    include_spatial = c(FALSE,TRUE),
    n_knots = c(150),
    seed = c(111,222,333)
  )

plan(multiprocess)
sdmTMB_cv_batch1 <- purrr::pmap(cv_args, sdmTMB_cv, data = d_trawl)
cv_args1 <- cv_args
cv_args1$cv_loglik <- c()
cv_args1$all_converged <- c()
for (i in seq_len(nrow(cv_args1))) {
  cv_args1$cv_loglik[[i]] <- round(sdmTMB_cv_batch[[i]]$sum_loglik, 1)
  cv_args1$all_converged[[i]] <- all(sdmTMB_cv_batch[[i]]$converg)
}
cv_args1$formula <- as.character(cv_args1$formula)
cv_args1$time_varying <- "NA"

cv_args_notv <- as.data.frame(cv_args1) 
# View(cv_args_notv)
# write.csv(cv_args_notv, file = "cv-non-time-varying.csv")
# saveRDS(sdmTMB_cv_batch1, file = "cv-non-time-varying.rds")
glimpse(cv_args_notv)
```

## All time-varying slope models
```{r}
cv_args <- generate_cv_args (formula = list(
    temperature_c ~ 0 + as.factor(year)),
    time_varying = list(
    ~ 0 + depth_scaled,
    ~ 0 + depth_scaled + depth_scaled2,
    ~ 0 + depth_scaled + depth_scaled2 + depth_scaled3),
    ar1_fields = c(FALSE, TRUE), 
    include_spatial = c(FALSE,TRUE),
    n_knots = c(150),
    seed = c(111,222,333)
    )

plan(multiprocess)
sdmTMB_cv_batch <- purrr::pmap(cv_args, sdmTMB_cv, data = d_trawl)
cv_args2 <- cv_args
cv_args2$cv_loglik <- c()
cv_args2$all_converged <- c()
for (i in seq_len(nrow(cv_args))) {
  cv_args2$cv_loglik[[i]] <- c(sdmTMB_cv_batch[[i]]$sum_loglik)
  cv_args2$all_converged[[i]] <- all(sdmTMB_cv_batch[[i]]$converg)
}
cv_args2$formula <- as.character(cv_args$formula)
cv_args2$time_varying <- as.character(cv_args$time_varying)
cv_args_tv <- as.data.frame(cv_args2) 
# View(cv_args_tv)
# write.csv(cv_args_tv, file = "cv-time-varying.csv")
# saveRDS(sdmTMB_cv_batch, file = "cv-time-varying.rds")
glimpse(cv_args_tv)
```


## vary n_knots for top model
```{r}
cv_args_knots <- generate_cv_args(formula = list(
    temperature_c ~ 0 + as.factor(year)),
    time_varying = list(
    ~ 0 + depth_scaled + depth_scaled2),
    #~ 0 + depth_scaled + depth_scaled2 + depth_scaled3),
    ar1_fields = c(FALSE), 
    include_spatial = c(TRUE),
    n_knots = c(80,120,180),
    seed = c(111,222,333)
    )

plan(multiprocess)
sdmTMB_cv_knots <- purrr::pmap(cv_args_knots, sdmTMB_cv, data = d_trawl)
cv_args3 <- cv_args_knots
cv_args3$cv_loglik <- c()
cv_args3$all_converged <- c()
for (i in seq_len(nrow(cv_args3))) {
  cv_args3$cv_loglik[[i]] <- c(sdmTMB_cv_knots[[i]]$sum_loglik)
  cv_args3$all_converged[[i]] <- all(sdmTMB_cv_knots[[i]]$converg)
}
cv_args3$formula <- as.character(cv_args3$formula)
cv_args3$time_varying <- as.character(cv_args3$time_varying)
cv_knots <- as.data.frame(cv_args3) 
# View(cv_knots)
# write.csv(cv_knots, file = "cv-varying-knots.csv")
# saveRDS(sdmTMB_cv_knots, file = "cv-varying-knots.rds")
glimpse(cv_knots)
```

Change seeds and refine knots
```{r}
cv_args_knots <- generate_cv_args(formula = list(
    temperature_c ~ 0 + as.factor(year)),
    time_varying = list(
    ~ 0 + depth_scaled + depth_scaled2),
    #~ 0 + depth_scaled + depth_scaled2 + depth_scaled3),
    ar1_fields = c(FALSE,TRUE), 
    include_spatial = c(TRUE),
    n_knots = c(135,145,155),
    seed = c(444,555)
    )

plan(multiprocess)
sdmTMB_cv_knots <- purrr::pmap(cv_args_knots, sdmTMB_cv, data = d_trawl)
cv_args3 <- cv_args_knots
cv_args3$cv_loglik <- c()
for (i in seq_len(nrow(cv_args3))) {
  cv_args3$cv_loglik[[i]] <- c(sdmTMB_cv_knots2[[i]]$sum_loglik)
}
cv_args3$formula <- as.character(cv_args3$formula)
cv_args3$time_varying <- as.character(cv_args3$time_varying)
cv_args_knots <- as.data.frame(cv_args3) 
# View(cv_args_knots)
# write.csv(cv_args_knots, file = "cv-refine-knots.csv")
# saveRDS(sdmTMB_cv_knots, file = "cv-refine-knots.rds")
glimpse(cv_args_knots)
```

Load saved batches:
```{r}
non_time_varying_batch <- readRDS(file = "cv-non-time-varying.rds")
time_varying_batch <- readRDS(file = "cv-time-varying.rds")
knot_varying_batch <- readRDS(file = "cv-varying-knots.rds")
knot_refining_batch <- readRDS(file = "cv-refine-knots.rds")

all_cv_loglik <- rbind(cv_args_notv, cv_args_tv, cv_args_knots, deparse.level = 1, make.row.names=TRUE)
View(all_cv_loglik)

by_seed <- all_cv_loglik %>% group_by(seed)
for (i in unique(all_cv_loglik$seed)){
  for (j in seq_len(nrow(diff_ll))) {
  by_seed[[i]]$delta_ll <- c()
  by_seed[[i]]$delta_ll[[j]] <- by_seed[[i]]$cv_loglik[[j]]-min(by_seed[[i]]$cv_loglik)
  }
}
all_cv_loglik <- by_seed %>% ungroup()
```

Current top model
```{r}
plan(multiprocess)
temp3_rw <- sdmTMB_cv(data = d_trawl, n_knots = 130, x = "X", y ="Y", k_folds = 10, 
                   formula = temperature_c ~ 0 + as.factor(year),
                   time_varying = ~ 0 + depth_scaled + depth_scaled2,
                   time = "year", family = gaussian(link = "identity"), 
                   ar1_fields = FALS, include_spatial = TRUE)
temp3_rw$models
sum(temp3_rw$sum_loglik)
```


```{r}
spde <- make_spde(d_trawl$X, d_trawl$Y, n_knots = 130)
plot_spde(spde)
```

```{r}
m_temp3_rw <- sdmTMB(d_trawl,
  temperature_c ~ 0 + as.factor(year),
  time_varying =  ~ 0 + depth_scaled + depth_scaled2 + depth_scaled3,
  ar1_fields = TRUE, include_spatial = TRUE, 
  time = "year", spde = spde, family = gaussian(link = "identity"),
  silent = TRUE)

predictions3_rw <- predict(m_temp3_rw)
predictions3_rw$data$residuals <- residuals(m_temp3_rw)
cor(predictions3_rw$data$est, predictions3_rw$data$temperature_c)^2 # 
aic(m_temp3_rw)
```

Residual plots:
```{r}
ggplot(predictions3_rw$data, aes(est, residuals)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~year)
```

```{r}
ggplot(predictions3_rw$data, aes(depth_scaled, residuals)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~year)
```

```{r}
ggplot(predictions3_rw$data, aes(depth_scaled, residuals)) +
  geom_point() +
  geom_smooth()
```

# A functions for plotting our predictions:

```{r}
plot_map <- function(dat, column = "est") {
  ggplot(dat, aes_string("X", "Y", colour = column)) +
    geom_point() +
    facet_wrap(~year) +
    coord_fixed()
}

plot_map_raster <- function(dat, column = "est") {
  ggplot(dat, aes_string("X", "Y", fill = column)) +
    geom_raster() +
    facet_wrap(~year) +
    coord_fixed()
}
```


## Plotting predictions
```{r}
qcs_grid$depth_scaled3 <- (qcs_grid$depth_scaled)^3
predictions_nd <- predict(m_temp3_rw, newdata = qcs_grid)
#saveRDS(predictions3_rw_nd$data, file = "qcs-temp.rds")
```

```{r}
plot_map_raster(predictions_nd$data, "est") +
  scale_fill_viridis_c(trans = "sqrt", option = "C") +
  ggtitle("Prediction (fixed effects + all random effects)")
```

```{r}
plot_map_raster(predictions_nd$data, "est_fe") +
  ggtitle("Prediction (fixed effects only)") +
  scale_fill_viridis_c(trans = "sqrt")
```

```{r, eval=FALSE}
plot_map_raster(predictions_nd$data, "est_re_s") +
  ggtitle("Spatial random effects only") +
  scale_fill_gradient2()
```

```{r}
plot_map_raster(predictions_nd$data, "est_re_st") +
  ggtitle("Spatiotemporal random effects only") +
  scale_fill_gradient2()
```


```{r}
ggplot(predictions3_rw$data, aes(temperature_c, est)) +
  geom_point() +
  facet_wrap(~year) +
  coord_fixed() +
  xlim(3,15) +
  ylim(3,15) +
  geom_abline()
```


```{r}
temp_cog <- get_cog(predictions_nd)

temp_cog %>% reshape2::dcast(year ~ coord, value.var = "est") %>%
  ggplot(aes(X, Y, colour = year)) + geom_path(arrow = arrow()) +
  scale_color_viridis_c()
```

```{r}
temp_cog %>%
  ggplot(aes(year, est, ymin = lwr, ymax = upr)) +
  geom_line() +
  geom_ribbon(alpha = 0.2) +
  facet_wrap(~coord, scales = "free_y")
```
