# Fit spatial temporal models to bottom temperature

```{r setup}
library(tidyverse)
library(sdmTMB)

d_trawl <- readRDS(here::here("analysis/tmb-sensor-explore/sensor-data-processed.rds"))

#set.seed(39201114) # original seed, predictions max out at .88 cor with true temp
set.seed(392011149)
```

```{r}
withheld_fe <- sample(d_trawl$fishing_event_id, size = round(nrow(d_trawl)*.2))

d_withheld <- filter(d_trawl, fishing_event_id %in% withheld_fe)

d_fit <- filter(d_trawl, !fishing_event_id %in% withheld_fe)

nrow(d_fit) # 3774
nrow(d_withheld) # 943
unique(d_withheld$year) 
unique(d_fit$year)
length(unique(d_fit$year))

# FIXME: need to work out a bug in production on this new data set
# It's crashing TMB.

#d_fit <- d_trawl
#d_withheld <- d_trawl
```

```{r}
spde <- make_spde(d_fit$X, d_fit$Y, n_knots = 250)
plot_spde(spde)
```

```{r}
m_temp1 <- sdmTMB(d_fit, temperature_c ~ 0 + as.factor(year) + depth_scaled,
  # time_varying =  ~ depth_scaled + depth_scaled2,
  time = "year", spde = spde, family = gaussian(link = "identity"), 
  ar1_fields = FALSE,
  anisotropy = FALSE, 
  include_spatial = TRUE, 
  silent = FALSE)

```

```{r}
m_temp1$model$par
# 2 * plogis(m_temp1$model$par[["ar1_phi"]]) - 1
exp(m_temp1$model$par[["ln_phi"]])
```

```{r}
predictions <- predict(m_temp1)
```

```{r}
predictions$data$residuals <- residuals(m_temp1)
```

```{r}
plot_map <- function(dat, column = "est") {
  ggplot(dat, aes_string("X", "Y", colour = column)) +
    geom_point() +
    facet_wrap(~year) +
    coord_fixed()
}
```

```{r}
plot_map(predictions$data, "est") +
  scale_colour_viridis_c() +
  ggtitle("Prediction (fixed effects + all random effects)")
```

```{r}
plot_map(predictions$data, "est_fe") +
  ggtitle("Prediction (fixed effects only)") +
  scale_colour_viridis_c()
```


```{r}
plot_map(predictions$data, "est_re_s") +
  ggtitle("Spatial random effects only") +
  scale_colour_gradient2()
```

```{r}
plot_map(predictions$data, "est_re_st") +
  ggtitle("Spatiotemporal random effects only") +
  scale_colour_gradient2()
```

```{r}
ggplot(predictions$data, aes(est, temperature_c)) +
  geom_point() +
  facet_wrap(~year) +
  coord_fixed() +
  geom_abline()
```

```{r}
ggplot(predictions$data, aes(est, residuals)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~year)
```

```{r}
ggplot(predictions$data, aes(depth_scaled, residuals)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~year)
```

```{r}
ggplot(predictions$data, aes(depth_scaled, residuals)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~year)
```

```{r}
ggplot(predictions$data, aes(depth_scaled, residuals)) +
  geom_point() +
  geom_smooth()
```

```{r}
ggplot(predictions$data, aes(X, Y, colour = residuals)) +
  geom_point() +
  facet_wrap(~year) +
  coord_fixed() +
  scale_color_gradient2()
```

 Looks a bit curved, let's try with a quadratic

```{r}
m_temp2 <- sdmTMB(d_fit, temperature_c ~ 0 + as.factor(year) + poly(depth_scaled, 2),
  time = "year", spde = spde, family = gaussian(link = "identity"),
  silent = TRUE)

predictions2 <- predict(m_temp2)
predictions2$data$residuals <- residuals(m_temp2)
```

```{r}
ggplot(predictions2$data, aes(depth_scaled, residuals)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~year)
```

```{r}
ggplot(predictions2$data, aes(depth_scaled, residuals)) +
  geom_point() +
  geom_smooth()
```

```{r}
ggplot(predictions2$data, aes(X, Y, colour = residuals)) +
  geom_point() +
  facet_wrap(~year) +
  coord_fixed() +
  scale_color_gradient2()
```

Try with a third degree polynomial:

```{r}
m_temp3 <- sdmTMB(d_fit, 
  temperature_c ~ 0 + as.factor(year) + poly(depth_scaled, 3),
  time = "year", spde = spde, family = gaussian(link = "identity"),
  silent = FALSE)

predictions3 <- predict(m_temp3)
predictions3$data$residuals <- residuals(m_temp3)
```

```{r}
m_temp3_rw <- sdmTMB(d_fit,
  temperature_c ~ 0 + as.factor(year),
  time_varying =  ~ 0 + poly(depth_scaled, 3),
  include_spatial = FALSE, ar1_fields = TRUE,
  time = "year", spde = spde, family = gaussian(link = "identity"),
  silent = FALSE)

predictions3_rw <- predict(m_temp3_rw)
predictions3_rw$data$residuals <- residuals(m_temp3_rw)
```

```{r}
m_temp3_rw_sp <- sdmTMB(d_fit,
  temperature_c ~ 0 + as.factor(year),
  time_varying =  ~ 0 + poly(depth_scaled, 3),
  include_spatial = TRUE, ar1_fields = TRUE,
  time = "year", spde = spde, family = gaussian(link = "identity"),
  silent = FALSE)

predictions3_rw_sp <- predict(m_temp3_rw)
predictions3_rw_sp$data$residuals <- residuals(m_temp3_rw)
```

```{r}
m_temp3_st <- sdmTMB(d_fit,
  temperature_c ~ 0 + as.factor(year),
  time_varying =  ~ 0 + poly(depth_scaled, 3),
  include_spatial = TRUE, ar1_fields = TRUE, spatial_trend = TRUE,
  time = "year", spde = spde, family = gaussian(link = "identity"),
  silent = FALSE)

predictions3_st <- predict(m_temp3_st)
predictions3_st$data$residuals <- residuals(m_temp3_st)
```

```{r}
ggplot(predictions3$data, aes(depth_scaled, residuals)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~year)
```

```{r}
ggplot(predictions3_rw$data, aes(depth_scaled, residuals)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~year)
```

```{r}
ggplot(predictions3_st$data, aes(depth_scaled, residuals)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~year)
```

```{r}
ggplot(predictions3$data, aes(depth_scaled, residuals)) +
  geom_point() +
  geom_smooth()
```

```{r}
ggplot(predictions3$data, aes(X, Y, colour = residuals)) +
  geom_point() +
  facet_wrap(~year) +
  coord_fixed() +
  scale_color_gradient2()
```

# That's getting pretty straight although it looks a bit heteroscedastic

# Perhaps this would work better with log temperature as the response
# since it basically isn't going to go lower than 0 degree celsius

```{r}
d_fit$log_temperature_c <- log(d_fit$temperature_c)
m_temp4 <- sdmTMB(d_fit, 
  log_temperature_c ~ 0 + as.factor(year),
  time_varying = ~ 0 + poly(depth_scaled, 3),
  #time_varying =  ~ 0 + depth_scaled,
  include_spatial = TRUE, ar1_fields = TRUE, spatial_trend = TRUE,
  time = "year", spde = spde, family = gaussian(link = "identity"),
  silent = TRUE)

predictions4 <- predict(m_temp4)
predictions4$data$residuals <- residuals(m_temp4)
```

```{r}
ggplot(predictions4$data, aes(depth_scaled, residuals)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~year)
```

```{r}
ggplot(predictions4$data, aes(depth_scaled, residuals)) +
  geom_point() +
  geom_smooth()
```

```{r}
ggplot(predictions4$data, aes(X, Y, colour = residuals)) +
  geom_point() +
  facet_wrap(~year) +
  coord_fixed() +
  scale_color_gradient2()
```

# That might've helped a little but not a lot. Let's try with depth and not log depth.

```{r}
m_temp5 <- sdmTMB(d_fit, temperature_c ~ 0 + as.factor(year) + poly(depth_m, 3),
  time = "year", spde = spde, family = gaussian(link = "identity"),
  silent = TRUE)

predictions5 <- predict(m_temp5)
predictions5$data$residuals <- residuals(m_temp5)
```

```{r}
ggplot(predictions5$data, aes(depth_scaled, residuals)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~year)
```

```{r}
ggplot(predictions5$data, aes(depth_scaled, residuals)) +
  geom_point() +
  geom_smooth()
```

# I don't think that helps with the heteroscedasticity but it made the curvature of the residuals a little bit worse.

```{r}
ggplot(predictions5$data, aes(est, residuals)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~year)
```

```{r}
ggplot(predictions5$data, aes(est, residuals)) +
  geom_point() +
  geom_smooth()
```

```{r}
aic <- function(m) {
  k <- length(m$model$par)
  nll <- m$model$objective
  2 * k - 2 * (-nll)
}
aic(m_temp1)
aic(m_temp2)
aic(m_temp3)
aic(m_temp3_rw)
aic(m_temp3_st)
aic(m_temp4)
aic(m_temp5)
```

# Conclusion: log depth, 3rd order polynomial with depth

```{r}
ggplot(predictions3$data, aes(est, temperature_c)) +
  geom_point() +
  facet_wrap(~year) +
  coord_fixed() +
  geom_abline()
```

# R2

```{r}
cor(predictions3$data$est, predictions3$data$temperature_c)^2
```

# Extrapolate:

```{r}
predictions3_nd <- predict(m_temp3, newdata = sdmTMB::qcs_grid)
#saveRDS(predictions3_nd$data, file = "qcs-temp.rds")
```


```{r}
ggplot(predictions3$data, aes(X, Y, colour = residuals)) +
  geom_point() +
  facet_wrap(~year) +
  coord_fixed() +
  scale_color_gradient2()
```

# A short function for plotting our predictions:

```{r}
plot_map <- function(dat, column = "est") {
  ggplot(dat, aes_string("X", "Y", fill = column)) +
    geom_raster() +
    facet_wrap(~year) +
    coord_fixed()
}
```

```{r}
plot_map(predictions3_nd$data, "est") +
  scale_fill_viridis_c(trans = "sqrt", option = "C") +
  ggtitle("Prediction (fixed effects + all random effects)")
```

```{r}
plot_map(predictions3_nd$data, "est_fe") +
  ggtitle("Prediction (fixed effects only)") +
  scale_fill_viridis_c(trans = "sqrt")
```

```{r}
plot_map(predictions3_nd$data, "est_re_s") +
  ggtitle("Spatial random effects only") +
  scale_fill_gradient2()
```

```{r}
plot_map(predictions3_nd$data, "est_re_st") +
  ggtitle("Spatiotemporal random effects only") +
  scale_fill_gradient2()
```

```{r}
m_temp3$model$par
# 2 * plogis(m_temp1$model$par[["ar1_phi"]]) - 1
exp(m_temp3$model$par[["ln_phi"]])

p_withheld <- predict(m_temp3, newdata = d_withheld)

#FIXME: p_withheld$data$temperature_c is all zeros?!?!?! 
# temp work around (first make sure both df in same order)
arrange(p_withheld$data, fishing_event_id) 
arrange(d_withheld, fishing_event_id) 
p_withheld$data$temperature_c <- d_withheld$temperature_c

cor(p_withheld$data$est, p_withheld$data$temperature_c)^2 # 0.88 in first 
```


```{r}
ggplot(p_withheld$data, aes(temperature_c,est)) +
  geom_point() +
  facet_wrap(~year) +
  coord_fixed() +
  xlim(3,15) +
  ylim(3,15) +
  geom_abline()
```

```{r}
m_temp3_rw$model$par
# 2 * plogis(m_temp1$model$par[["ar1_phi"]]) - 1
exp(m_temp3_rw$model$par[["ln_phi"]])

p_withheld_rw <- predict(m_temp3_rw, newdata = d_withheld)

#FIXME: p_withheld$data$temperature_c is all zeros?!?!?! 
# temp work around (first make sure both df in same order)
arrange(p_withheld_rw$data, fishing_event_id) 
arrange(d_withheld, fishing_event_id) 
p_withheld_rw$data$temperature_c <- d_withheld$temperature_c

cor(p_withheld_rw$data$est, p_withheld_rw$data$temperature_c)^2 # 0.86?
```

```{r}
ggplot(p_withheld_rw$data, aes(temperature_c,est)) +
  geom_point() +
  facet_wrap(~year) +
  coord_fixed() +
  xlim(3,15) +
  ylim(3,15) +
  geom_abline()
```


```{r}
m_temp3_st$model$par
# 2 * plogis(m_temp1$model$par[["ar1_phi"]]) - 1
exp(m_temp3_st$model$par[["ln_phi"]])

p_withheld_st <- predict(m_temp3_st, newdata = d_withheld)

#FIXME: p_withheld$data$temperature_c is all zeros?!?!?! 
# temp work around (first make sure both df in same order)
arrange(p_withheld_st$data, fishing_event_id) 
arrange(d_withheld, fishing_event_id) 
p_withheld_st$data$temperature_c <- d_withheld$temperature_c

cor(p_withheld_st$data$est, p_withheld_st$data$temperature_c)^2
```

```{r}
ggplot(p_withheld_st$data, aes(temperature_c,est)) +
  geom_point() +
  facet_wrap(~year) +
  coord_fixed() +
  xlim(3,15) +
  ylim(3,15) +
  geom_abline()
```

```{r}
m_temp4$model$par
# 2 * plogis(m_temp1$model$par[["ar1_phi"]]) - 1
exp(m_temp4$model$par[["ln_phi"]])

p_withheld4 <- predict(m_temp4, newdata = d_withheld)

#FIXME: p_withheld$data$temperature_c is all zeros?!?!?! 
# temp work around (first make sure both df in same order)
arrange(p_withheld4$data, fishing_event_id) 
arrange(d_withheld, fishing_event_id) 
p_withheld4$data$temperature_c <- d_withheld$temperature_c

cor(p_withheld4$data$est, p_withheld4$data$temperature_c)^2 # 0.86
```


```{r}
ggplot(p_withheld4$data, aes(log(temperature_c),est)) +
  geom_point() +
  facet_wrap(~year) +
  coord_fixed() +
  xlim(1, 3) +
  ylim(1, 3) +
  geom_abline()
```

```{r}
temp_cog <- get_cog(predictions3_nd)

temp_cog %>% reshape2::dcast(year ~ coord, value.var = "est") %>%
  ggplot(aes(X, Y, colour = year)) + geom_path(arrow = arrow()) +
  scale_color_viridis_c()
```

```{r}
temp_cog %>%
  ggplot(aes(year, est, ymin = lwr, ymax = upr)) +
  geom_line() +
  geom_ribbon(alpha = 0.2) +
  facet_wrap(~coord, scales = "free_y")
```